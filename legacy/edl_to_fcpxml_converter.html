<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>EDL → FCPXML Konverter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2rem;
      line-height: 1.5;
      background: #f8f9fa;
      color: #212529;
    }
    h1 {
      font-size: 1.75rem;
      margin-bottom: 1.25rem;
    }
    label {
      display: block;
      margin-bottom: 0.75rem;
    }
    input[type="file"],
    input[type="number"] {
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fff;
    }
    #convertBtn {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.5rem;
      background: #0d6efd;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
    }
    #convertBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #convertBtn:not(:disabled):hover {
      background: #0b5ed7;
    }
    #downloadLink {
      display: block;
      margin-top: 1rem;
      font-size: 1rem;
      text-decoration: none;
      color: #0d6efd;
    }
  </style>
</head>
<body>
  <h1>EDL → FCPXML Konverter</h1>

  <label>
    EDL‑Datei auswählen:
    <input type="file" id="edlFile" accept=".edl,.txt" />
  </label>

  <label>
    Framerate (FPS):
    <input type="number" id="fps" value="25" step="0.01" min="1" />
  </label>

  <button id="convertBtn" disabled>Konvertieren</button>
  <a id="downloadLink" style="display: none;">FCPXML herunterladen</a>

  <script>
    /* Hilfsfunktionen */
    function escapeXML(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&apos;");
    }

    function parseTimecode(tc, fps) {
      const [hh, mm, ss, ff] = tc.split(":").map(Number);
      return hh * 3600 + mm * 60 + ss + ff / fps;
    }

    function parseEDL(edlText) {
      const lines = edlText.split(/\r?\n/);
      const markers = [];

      for (let i = 0; i < lines.length; i++) {
        const eventMatch = lines[i].match(
          /^\s*(\d{1,3})\s+\d+\s+\w\s+\w\s+(\d{2}:\d{2}:\d{2}:\d{2})/
        );
        if (eventMatch) {
          const timecode = eventMatch[2];
          // Kommentar steht i + 1 (Resolve) oder i + 2 (manchmal Leerzeile dazwischen)
          let commentLine = lines[i + 1] || "";
          if (!commentLine.trim() && lines[i + 2]) commentLine = lines[i + 2];
          const commentMatch = commentLine.match(/\|M:([^|]+?)(?:\s*\|D:|$)/);
          const comment = commentMatch ? commentMatch[1].trim() : "Marker";
          markers.push({ timecode, comment });
        }
      }
      return markers;
    }

    function buildFCPXML(markers, fps) {
      if (!markers.length) {
        throw new Error("Keine Marker gefunden.");
      }
      // Zeit in Sekunden berechnen und auf 0 normalisieren
      const converted = markers.map((m) => ({
        seconds: parseTimecode(m.timecode, fps),
        comment: m.comment,
      }));
      const minSec = Math.min(...converted.map((m) => m.seconds));
      converted.forEach((m) => (m.seconds -= minSec));
      const seqDuration = (converted[converted.length - 1].seconds + 1).toFixed(2) + "s";

      const xml = [
        "<?xml version=\"1.0\" encoding=\"UTF-8\"?>",
        "<fcpxml version=\"1.8\">",
        "  <resources>",
        `    <format id=\"r1\" name=\"FFVideoFormat\" frameDuration=\"1/${fps}s\" width=\"1920\" height=\"1080\" colorSpace=\"601\"/>`,
        "  </resources>",
        "  <library>",
        "    <event name=\"EDL Import\" uid=\"event-1\">",
        "      <project name=\"EDL Sequence\" uid=\"proj-1\">",
        `        <sequence duration=\"${seqDuration}\" format=\"r1\">`,
        "          <spine>",
        `            <gap name=\"Gap\" offset=\"0s\" duration=\"${seqDuration}\">`,
      ];

      converted.forEach((m, idx) => {
        xml.push(
          `              <marker start=\"${m.seconds.toFixed(4)}s\" duration=\"1s\" value=\"${escapeXML(
            m.comment
          )}\"/>`
        );
      });

      xml.push(
        "            </gap>",
        "          </spine>",
        "        </sequence>",
        "      </project>",
        "    </event>",
        "  </library>",
        "</fcpxml>"
      );

      return xml.join("\n");
    }

    /* UI‑Logik */
    const fileInput = document.getElementById("edlFile");
    const fpsInput = document.getElementById("fps");
    const convertBtn = document.getElementById("convertBtn");
    const downloadLink = document.getElementById("downloadLink");

    fileInput.addEventListener("change", () => {
      convertBtn.disabled = !fileInput.files.length;
      downloadLink.style.display = "none";
    });

    convertBtn.addEventListener("click", () => {
      if (!fileInput.files.length) return;
      const reader = new FileReader();
      convertBtn.disabled = true;
      reader.onload = () => {
        try {
          const fps = parseFloat(fpsInput.value) || 25;
          const edl = reader.result;
          const markers = parseEDL(edl);
          const fcpxml = buildFCPXML(markers, fps);
          const blob = new Blob([fcpxml], { type: "application/xml" });
          const url = URL.createObjectURL(blob);
          downloadLink.href = url;
          downloadLink.download = fileInput.files[0].name.replace(/\.edl$/i, "") + ".xml";
          downloadLink.style.display = "block";
          downloadLink.textContent = "FCPXML herunterladen";
        } catch (err) {
          alert(err.message || "Fehler beim Konvertieren.");
        } finally {
          convertBtn.disabled = false;
        }
      };
      reader.readAsText(fileInput.files[0]);
    });
  </script>
</body>
</html>

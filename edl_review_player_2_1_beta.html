<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EDL Review Player ¬∑ YouTube & Dateien</title>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
  <style>
    :root { --gap: 12px; --radius: 10px; --bg:#0f1220; --panel:#151a2d; --text:#f2f5ff; --muted:#a7b0c3; --warn:#ffb84d; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:20px; display:grid; grid-template-columns: 1fr auto; gap:var(--gap); align-items:center; border-bottom:1px solid #273055}
    h1{ font-size:20px; margin:0; }
    .panel{ background:var(--panel); padding:var(--gap); border-radius:var(--radius); }
    .stack{ display:grid; gap:var(--gap); }
    .row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"], select { background:#0e1426; color:var(--text); border:1px solid #2a355e; border-radius:8px; padding:10px 12px; min-width:240px; }
    button{ background:#2a355e; color:var(--text); border:0; border-radius:8px; padding:10px 14px; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    #player-wrap{ aspect-ratio:16/9; width:100%; background:black; border-radius:10px; overflow:hidden; position:relative }
    #player, #file-player{ position:absolute; inset:0; width:100%; height:100%; }
    #file-player{ display:none; background:black; }
    video{ width:100%; height:100%; }
    #comments li{ display:flex; gap:8px; align-items:center; padding:6px; }
    #comments input{ width:100%; background:#0e1426; color:var(--text); border:1px solid #2a355e; border-radius:6px; padding:6px 8px; }
    .top-right{ justify-self:end; display:flex; gap:8px; align-items:center; }
    .banner{ display:none; background:var(--warn); color:#111; padding:8px 12px; border-radius:8px; font-size:12px; }
    .badge{ font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0006; color:#fff; border-radius:6px; padding:2px 6px; }
    .btn-sm{ padding:6px 10px; line-height:1; }
    .tc{ width:120px; }
    .idx{ width:72px; }
    #comments input{ min-width:0; }
    footer{ padding:16px; text-align:center; color:var(--muted) }
    #resolver-host{ position:absolute; width:0; height:0; overflow:hidden; opacity:0; pointer-events:none; }
  
    /* --- Enhancements for responsiveness & accessibility --- */
    :root{
      --gap-sm: 8px;
      --shadow: 0 6px 24px rgba(0,0,0,.25);
    }
    body{ text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased; }
    main{ padding-inline:16px; }
    .panel{ box-shadow: var(--shadow); }
    button{
      display:inline-flex; align-items:center; justify-content:center;
      font-size:16px; /* prevents iOS zoom-on-focus */
      transition: transform .06s ease, opacity .2s ease;
    }
    button:active{ transform: translateY(1px); }
    a, button, input, select{
      outline:none;
    }
    a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible{
      box-shadow: 0 0 0 3px rgba(51,153,255,.4);
      border-color:#3399ff;
    }
    /* Make long inputs expand nicely on wider screens */
    #comment-form{ gap: var(--gap); }
    #comment-input{ flex:1 1 400px; }
    /* Constrain overall content width on desktops for better readability */
    @media (min-width: 1100px){
      header, main, footer{ max-width: 1100px; margin-inline:auto; }
    }
    /* Tablet and below */
    @media (max-width: 900px){
      header{ grid-template-columns: 1fr; row-gap: var(--gap); }
      .top-right{ justify-self:start; }
    }
    /* Mobile layout */
    @media (max-width: 700px){
      :root{ --gap: var(--gap-sm); }
      header{ padding:14px; position:sticky; top:0; background:var(--bg); z-index:10; border-bottom-color:#1a2342; }
      h1{ font-size: clamp(16px, 5vw, 20px); }
      .row{ flex-direction:column; align-items:stretch; gap: var(--gap-sm); }
      label{ font-size:12px; }
      input[type="text"], select, button, #file-input{
        width:100%; min-width:0;
      }
      #player-wrap{ border-radius:8px; }
      #comments li{ flex-direction:column; align-items:stretch; gap: var(--gap-sm); }
      #comments input{ width:100%; }
      .tc, .idx{ width:100%; }
      .btn-sm{ padding:12px 14px; }
      #clip-info{ display:block; margin-top:4px; }
      footer{ padding:12px; }
    }
    /* Ultra-small phones */
    @media (max-width: 360px){
      header{ padding:10px; }
      main{ padding-inline:10px; }
    }
    
/* --- Mobile polish v2: no horizontal scroll + compact comment field --- */
html, body { max-width: 100vw; overflow-x: hidden; }
#app, #root, main, header, footer { max-width: 100%; }
img, video, canvas, iframe { max-width: 100%; height: auto; }
* { box-sizing: border-box; }
.filename, .clipname, .path, .tc, .idx { overflow-wrap: anywhere; word-break: break-word; }

#player-wrap{ overflow:hidden; }

/* Ensure tables/lists don't force horizontal scroll */
table { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }

/* Comment add field compact on mobile */
@media (max-width: 700px){
  #comment-form { gap: 8px; }
  #comment-input, #new-comment, textarea#comment-input {
    height: 40px;             /* compact height */
    min-height: 40px;
    padding: 8px 10px;
    line-height: 1.2;
  }
  /* If it's a textarea, keep it single-line height but allow manual grow */
  textarea#comment-input { resize: vertical; }
  /* Buttons inline where space allows; otherwise wrap */
  #comment-form button { padding: 10px 12px; }
  /* Avoid nested elements creating wider-than-viewport layouts */
  .row, .panel, .controls, .toolbar { max-width: 100%; }
}

</style>
    
</head>
<body>
<header>
  <div class="row">
    <h1 id="t_title">EDL Review Player ¬∑ YouTube & Dateien</h1>
    <div class="row">
      <label for="yt-url" id="t_ytlabel">YouTube URL (Video/Playlist/Live)</label>
      <input id="yt-url" type="text" placeholder="https://youtu.be/‚Ä¶ | /watch?v=‚Ä¶ | /playlist?list=‚Ä¶ | /live/‚Ä¶ | /shorts/‚Ä¶"/>
      <button id="add-url" type="button">Hinzuf√ºgen</button>
    </div>
    <div class="row">
      <label for="file-input" id="t_filelabel">Datei(en) hinzuf√ºgen</label>
      <input id="file-input" type="file" accept="video/*" multiple/>
    </div>
    <div class="row">
      <label id="t_sourcelabel">Quelle w√§hlen</label>
      <select id="source-select"></select>
      <span id="diag" class="badge" style="display:none"></span>
    </div>
    <div class="row">
      <label id="t_edlimport">.edl Marker importieren</label>
      <input id="edl-input" type="file" accept=".edl,text/plain"/>
    </div>
    <div id="fileproto" class="banner">
      Hinweis: Du √∂ffnest die Datei √ºber <span class="badge">file://</span>.
      Der YouTube-Player kann so Fehler (<code>2</code>, <code>5</code>) werfen.
      Starte die Datei besser √ºber einen lokalen Webserver (z.‚ÄØB. <span class="badge">python -m http.server</span>) oder lege sie auf http(s).
    </div>
  </div>
  <div class="top-right">
    <button id="lang-toggle" type="button" title="Switch UI language">EN</button>
  </div>
</header>
<main class="stack" style="padding:16px">
  <section class="panel stack">
    <div id="player-wrap">
      <div id="player"></div>
      <video id="file-player" controls></video>
      <div id="resolver-host"></div>
    </div>
    <form id="comment-form" class="row" onsubmit="return false">
      <input id="comment-input" type="text" placeholder="Kommentar hinzuf√ºgen‚Ä¶"/>
      <button id="add-comment" type="button">Add</button>
      <span id="clip-info" style="font-size:12px;color:var(--muted)"></span>
    </form>
    <ul id="comments" class="panel" style="list-style:none; margin:0"></ul>
    <div class="row">
      <button id="download-edl" type="button">üíæ EDL exportieren</button>
      <button id="clear-comments" type="button">üóëÔ∏è Alle l√∂schen</button>
    </div>
  </section>
</main>
<footer>PHANTOMCREW ¬∑ EDL Tools</footer>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  document.addEventListener('DOMContentLoaded', init);

  function init(){
    const urlInput=$('yt-url'), addUrlBtn=$('add-url'), fileInput=$('file-input'), selectEl=$('source-select');
    const commentInput=$('comment-input'), addCommentBtn=$('add-comment');
    const commentsEl=$('comments'), downloadBtn=$('download-edl'), clearBtn=$('clear-comments');
    const edlInput=$('edl-input'), fileVideo=$('file-player'), langToggle=$('lang-toggle');
    const diag=$('diag'), fileBanner=$('fileproto'), clipInfo=$('clip-info'), resolverHost=$('resolver-host');

    // ---------- State ----------
    const sources=[]; // {type:'video'|'file', id, title, comments, fileUrl, fileName, playlist}
    let current=0; let ytPlayer=null; let ytReady=false;
    let resolver=null; let resolverReady=false;
    const titleCache=new Map(); // id -> title

    // ---------- i18n ----------
    let LANG='de';
    const I18N={
      de:{ title:'EDL Review Player ¬∑ YouTube & Dateien', ytlabel:'YouTube URL (Video/Playlist/Live)', filelabel:'Datei(en) hinzuf√ºgen', sourcelabel:'Quelle w√§hlen', add:'Hinzuf√ºgen', addComment:'Kommentar hinzuf√ºgen‚Ä¶', edlimport:'.edl Marker importieren', export:'üíæ EDL exportieren', clear:'üóëÔ∏è Alle l√∂schen' },
      en:{ title:'EDL Review Player ¬∑ YouTube & Files', ytlabel:'YouTube URL (Video/Playlist/Live)', filelabel:'Add file(s)', sourcelabel:'Select source', add:'Add', addComment:'Add a comment‚Ä¶', edlimport:'Import .edl markers', export:'üíæ Export EDL', clear:'üóëÔ∏è Clear all' }
    };
    function applyLang(){
      const t=I18N[LANG];
      $('t_title').textContent=t.title; $('t_ytlabel').textContent=t.ytlabel; $('t_filelabel').textContent=t.filelabel; $('t_sourcelabel').textContent=t.sourcelabel;
      addUrlBtn.textContent=t.add; addCommentBtn.textContent=t.add; commentInput.placeholder=t.addComment; $('t_edlimport').textContent=t.edlimport; downloadBtn.textContent=t.export; clearBtn.textContent=t.clear;
      langToggle.textContent=(LANG==='de'?'EN':'DE'); document.documentElement.lang=LANG;
    }
    applyLang();
    langToggle.addEventListener('click',()=>{ LANG=LANG==='de'?'en':'de'; applyLang(); });

    // ---------- Helpers ----------
    const two=n=>n<10?('0'+n):(''+n);
    function formatEDL(seconds){ const fps=30; const h=Math.floor(seconds/3600),m=Math.floor((seconds%3600)/60),s=Math.floor(seconds%60),f=Math.floor((seconds%1)*fps); return `${two(h)}:${two(m)}:${two(s)}:${two(f)}`; }
    function parseEDLTime(tc){ const [hh,mm,ss,ff]=tc.split(':').map(x=>parseInt(x,10)); const fps=30; if([hh,mm,ss,ff].some(isNaN)) return 0; return hh*3600+mm*60+ss+(ff/fps); }
    function isValidVideoId(id){ return /^[A-Za-z0-9_-]{11}$/.test(id||''); }
    function sourceLabel(src){ return src.title || (src.type==='file'?src.fileName: `YouTube ${src.id}`); }
    function showFilePlayer(show){ $('file-player').style.display=show?'block':'none'; $('player').style.display=show?'none':'block'; }

    function getYouTubeId(u){
      try{
        const url=new URL(u); const host=url.hostname.replace(/^www\./,'');
        const clean=v=>(v||'').replace(/[^a-zA-Z0-9_-]/g,'');
        const list=url.searchParams.get('list'); if(list) return {type:'playlist', id:clean(list)};
        if(host==='youtu.be'){ const id=clean(url.pathname.substring(1)); if(id) return {type:'video', id}; }
        const v=url.searchParams.get('v'); if(v) return {type:'video', id:clean(v)};
        if(host.endsWith('youtube.com')){
          const p=url.pathname.split('/').filter(Boolean);
          if(p[0]==='live'&&p[1]) return {type:'video', id:clean(p[1])};
          if(p[0]==='shorts'&&p[1]) return {type:'video', id:clean(p[1])};
          if(p[0]==='playlist'){ const pl=url.searchParams.get('list'); if(pl) return {type:'playlist', id:clean(pl)}; }
          if(p[0]==='videoseries'){ const pl=url.searchParams.get('list'); if(pl) return {type:'playlist', id:clean(pl)}; }
        }
      }catch(e){}
      return null;
    }

    // ---------- Background title resolver (no flicker) ----------
    function ensureResolver(){
      if(resolver || !window.YT || !YT.Player) return;
      const pv={ rel:0, controls:0, disablekb:1, modestbranding:1, iv_load_policy:3, playsinline:1 };
      resolver=new YT.Player('resolver-host',{ width:'0', height:'0', playerVars:pv, events:{
        onReady:()=>{ resolverReady=true; processTitleQueue(); },
        onError:()=>{ /* ignore resolver errors */ }
      }});
    }

    async function getTitleById(id){
      if(titleCache.has(id)) return titleCache.get(id);
      if(!resolverReady) await waitFor(()=>resolverReady, 2000);
      if(!resolver) return '';
      const attempts=[300,600,900,1200,1500];
      try{ resolver.cueVideoById({videoId:id}); }catch(e){ return ''; }
      for(const wait of attempts){
        await delay(wait);
        try{
          const data = resolver.getVideoData ? resolver.getVideoData() : null;
          const t = data && data.title ? String(data.title) : '';
          if(t){ titleCache.set(id, t); return t; }
        }catch(e){ /* try again */ }
      }
      return '';
    }

    function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function waitFor(cond, timeout=2000){
      return new Promise((res)=>{
        const start=Date.now();
        (function tick(){
          if(cond()) return res(true);
          if(Date.now()-start>=timeout) return res(false);
          setTimeout(tick,50);
        })();
      });
    }

    // ---------- Title queue ----------
    const titleQueue=[];
    let titleBusy=false;
    async function processTitleQueue(){
      if(titleBusy) return;
      titleBusy=true;
      ensureResolver();
      while(titleQueue.length){
        const idx=titleQueue.shift();
        const src=sources[idx];
        if(!src || src.type!=='video' || src.title) continue;
        const title = await getTitleById(src.id);
        if(title){
          src.title=title;
          const opt=selectEl.options[idx];
          if(opt) opt.textContent=sourceLabel(src);
        }
      }
      titleBusy=false;
    }

    // ---------- YouTube IFrame API ----------
    const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady=function(){
      const playerVars={ rel:0, modestbranding:1, iv_load_policy:3, enablejsapi:1, playsinline:1 };
      if(location.protocol.startsWith('http')){ playerVars.origin=location.origin; } else { fileBanner.style.display='block'; }
      ytPlayer=new YT.Player('player',{ width:'100%', height:'100%', playerVars, events:{ onReady:onYTReady, onStateChange:onYTState, onError:onYTError } });
      ensureResolver();
    };
    function onYTReady(){ ytReady=true; if(sources[current]) cueCurrent(false); }
    function onYTState(){ /* no longer used for title loading to avoid flicker */ }
    function onYTError(e){
      const code=e?.data;
      if(diag){ diag.style.display='inline-block'; diag.textContent='YT err '+code; }
      if(location.protocol==='file:') fileBanner.style.display='block';
    }

    // ---------- Build sources ----------
    function addVideoById(id, title='', playlistId=null){
      if(!isValidVideoId(id)){ alert((LANG==='de'?'Ung√ºltige Video-ID: ':'Invalid video ID: ')+id); return; }
      const src={type:'video', id, title, comments:[], playlist: playlistId || null};
      sources.push(src);
      const opt=document.createElement('option'); opt.textContent=sourceLabel(src); selectEl.add(opt);
      if(!title){ titleQueue.push(sources.length-1); processTitleQueue(); }
      if(selectEl.selectedIndex<0){ selectEl.selectedIndex=0; current=0; }
      cueCurrent(false);
      updateUrlWithCurrentSource();
    }

    async function expandPlaylistToVideos(playlistId, preselectVideoId=null){
      if(!ytReady || !ytPlayer){ alert(LANG==='de'?'YouTube-API noch nicht bereit.':'YouTube API not ready yet.'); return; }
      try{
        ytPlayer.cuePlaylist({ listType:'playlist', list:playlistId, index:0 });
        await new Promise(r=>setTimeout(r, 900));
        const ids = (ytPlayer.getPlaylist && ytPlayer.getPlaylist()) || [];
        if(!ids.length){ alert(LANG==='de'?'Playlist konnte nicht geladen werden.':'Could not load playlist.'); return; }

        const startIdx = sources.length;
        ids.forEach(id=> addVideoById(id, '', playlistId));
        for(let i=0;i<ids.length;i++){ titleQueue.push(startIdx+i); }
        processTitleQueue();

        if(preselectVideoId){
          const idx = sources.findIndex((s, i)=> i>=startIdx && s.type==='video' && s.id===preselectVideoId);
          if(idx>=0){ selectEl.selectedIndex = idx; current = idx; cueCurrent(false); }
        }else{
          selectEl.selectedIndex = startIdx; current = startIdx; cueCurrent(false);
        }
        updateUrlWithCurrentSource();
      }catch(err){ if(diag){ diag.style.display='inline-block'; diag.textContent='PL err'; } }
    }

    function addSourceFromUrl(u){
      const meta=getYouTubeId(u);
      if(!meta){ alert(LANG==='de'?'Ung√ºltige YouTube-URL':'Invalid YouTube URL'); return; }
      if(diag){ diag.style.display='inline-block'; diag.textContent=(meta.type==='video'?'VID:':'PL:')+meta.id; }
      if(meta.type==='video'){ addVideoById(meta.id,''); }
      else { expandPlaylistToVideos(meta.id); }
    }

    addUrlBtn.addEventListener('click',()=>{ const u=urlInput.value.trim(); if(!u) return; addSourceFromUrl(u); urlInput.value=''; });
    urlInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); addUrlBtn.click(); }});

    // ---------- FILES ----------
    fileInput.addEventListener('change',()=>{
      if(fileInput.files?.length){
        for(const f of fileInput.files){
          const url=URL.createObjectURL(f);
          const src={type:'file', id:url, fileUrl:url, fileName:f.name, title:f.name, comments:[]};
          sources.push(src);
          const opt=document.createElement('option'); opt.textContent=sourceLabel(src); selectEl.add(opt);
        }
        if(selectEl.selectedIndex<0){ selectEl.selectedIndex=0; current=0; }
        cueCurrent(false);
      }
    });

    // ---------- Select change ----------
    selectEl.addEventListener('change',()=>{ current=selectEl.selectedIndex; cueCurrent(false); updateUrlWithCurrentSource(); });

    function cueCurrent(resetTime){
      const src=sources[current]; if(!src) return;
      if(src.type==='file'){
        showFilePlayer(true);
        if(resetTime!==false) fileVideo.currentTime = 0;
        fileVideo.src=src.fileUrl;
        fileVideo.pause();
        updateCommentList();
        clipInfo.textContent='';
        return;
      }
      if(!ytReady||!ytPlayer){ return; }
      showFilePlayer(false);
      try{
        ytPlayer.cueVideoById({videoId:src.id});
        setTimeout(()=>{ ytPlayer.pauseVideo?.(); }, 200);
      }catch(err){ if(diag){ diag.style.display='inline-block'; diag.textContent='cue error'; } }
      updateCommentList();
      clipInfo.textContent='';
    }

    // ---------- URL sync (v & list) ----------
    function updateUrlWithCurrentSource(){
      const src = sources[current];
      const base = location.origin + location.pathname;
      if(!src || src.type!=='video'){
        history.replaceState(null, '', base);
        return;
      }
      const params = new URLSearchParams();
      if(src.playlist) params.set('list', src.playlist);
      params.set('v', src.id);
      history.replaceState(null, '', `${base}?${params.toString()}`);
    }

    // ---------- Comments ----------
    function updateCommentList(){
      const src=sources[current]; if(!src) return;
      commentsEl.innerHTML='';
      (src.comments||[]).forEach((c,i)=>commentsEl.appendChild(formatCommentItem(c,i)));
      downloadBtn.disabled=(src.comments||[]).length===0;
    }
    function formatCommentItem(obj, idx){
      const li=document.createElement('li');
      const text=document.createElement('input'); text.type='text'; text.value=obj.comment||''; text.addEventListener('input',()=>{ obj.comment=text.value; hardPause(); });
      const time=document.createElement('input'); time.type='text'; time.value=obj.time||'00:00:00:00'; time.className='tc'; time.addEventListener('input',()=>{ obj.time=time.value; });
      const gotoBtn=document.createElement('button'); gotoBtn.type='button'; gotoBtn.textContent='Go To';
      gotoBtn.onclick=()=>{
        const seconds=parseEDLTime(obj.time||'00:00:00:00'); const src=sources[current];
        if(src.type==='file'){ fileVideo.currentTime=seconds; fileVideo.pause(); }
        else { const was=ytPlayer.getPlayerState?.()===1; ytPlayer.seekTo(seconds,true); if(!was) ytPlayer.pauseVideo?.(); }
      };
      const delBtn=document.createElement('button'); delBtn.type='button'; delBtn.textContent='Delete'; delBtn.onclick=()=>removeCommentAt(idx);
      li.append(text,time,gotoBtn,delBtn);
      return li;
    }
    function removeCommentAt(i){ const src=sources[current]; if(!src) return; src.comments.splice(i,1); updateCommentList(); }
    function addComment(){
      const src=sources[current]; if(!src) return; const text=commentInput.value.trim(); if(!text) return; hardPause();
      const seconds = src.type==='file' ? (fileVideo.currentTime||0) : (ytPlayer?.getCurrentTime?.()||0);
      src.comments.push({ comment:text, time:formatEDL(seconds) });
      commentInput.value=''; updateCommentList();
    }
    function hardPause(){ const src=sources[current]; if(!src) return; if(src.type==='file'){ if(!fileVideo.paused) fileVideo.pause(); } else if(ytPlayer && ytPlayer.pauseVideo){ try{ ytPlayer.pauseVideo(); }catch(e){} } }
    addCommentBtn.addEventListener('click',()=>{ addComment(); resumePlayback(); });
    commentInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); addComment(); resumePlayback(); } });
    // NEW: auto-pause while typing in the comment field
    commentInput.addEventListener('input', hardPause);
    // Keep existing pause-on-pointer behavior
    $('comment-form').addEventListener('pointerdown', hardPause, {capture:true});

    function resumePlayback(){ const src=sources[current]; if(!src) return; if(src.type==='file'){ fileVideo.play?.(); } else if(ytPlayer && ytPlayer.playVideo){ try{ ytPlayer.playVideo(); }catch(e){} } }

    clearBtn.addEventListener('click',()=>{
      const msg= LANG==='de'? 'Alle Kommentare f√ºr die aktuelle Quelle l√∂schen?' : 'Delete all comments for the current source?';
      if(!confirm(msg)) return; const src=sources[current]; if(!src) return; src.comments=[]; updateCommentList();
    });

    // ---------- EDL Import ----------
    edlInput.addEventListener('change', ()=>{ const file=edlInput.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=e=>parseEDL(e.target.result); reader.readAsText(file); });
    function parseEDL(content){
      const src=sources[current]; if(!src) return;
      const lines=content.split(/\r?\n/); let lastTime='';
      for(const line of lines){
        if(line.includes('V     C        ')){ lastTime=line.split('V     C        ')[1].split(' ')[0].trim(); }
        else if(line.includes('|M:')){ const commentText=line.split('|M:')[1].split('|')[0].trim(); if(!lastTime) continue; src.comments.push({ comment:commentText, time:lastTime }); lastTime=''; }
      }
      updateCommentList();
    }

    // ---------- EDL Export ----------
    downloadBtn.addEventListener('click', ()=>{
      const src=sources[current]; if(!src) return;
      const title= src.title || (src.type==='file'? src.fileName : src.id);
      let edl=`TITLE: PHANTOMCREW.DE Edit list for ${title}\nFCM: NON-DROP FRAME\n\n`;
      let i=1;
      const write=(c)=>{ const tc=formatEDL(parseEDLTime(c.time)); edl+=`00${two(i++)}  001      V     C        ${tc} ${tc} ${tc} ${tc} \n |C:ResolveColorBlue |M:${c.comment} |D:1\n\n`; };
      for(const c of (src.comments||[])) write(c);
      const blob=new Blob([edl],{type:'text/plain;charset=utf-8'});
      const safeName=(title||'session').replace(/[^a-z0-9_\-]+/gi,'_');
      saveAs(blob, `${safeName}.edl`);
    });

    // ---------- Auto-load from URL (?v=... and/or ?list=...) ----------
    (async function autoLoadFromUrl(){
      const params = new URLSearchParams(location.search);
      const startVid  = params.get('v');
      const startList = params.get('list');
      // Warten bis YouTube bereit (max. 5s)
      await waitFor(()=>ytReady, 5000);
      if(startList){
        const vidOk = startVid && isValidVideoId(startVid) ? startVid : null;
        expandPlaylistToVideos(startList, vidOk);
      } else if(startVid && isValidVideoId(startVid)) {
        addVideoById(startVid, '');
      }
    })();

    if(location.protocol==='file:'){ fileBanner.style.display='block'; }
  }
})();
</script>
</body>
</html>

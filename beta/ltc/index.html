<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Phantomcrew LTC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --pc-dark: #000436;
      --pc-dark-blue: #1D3A69;
      --pc-accent-red: #FF5050;
      --pc-gold: #C99443;
      --pc-grey: #ACACAC;
      --pc-light: #ECEBED;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1D3A69 0%, #000436 55%, #000110 100%);
      color: var(--pc-light);
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      max-width: 440px;
      margin: 16px;
      padding: 18px 16px 16px;
      background: rgba(0, 4, 54, 0.95);
      border-radius: 16px;
      border: 1px solid rgba(201, 148, 67, 0.5);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    h1 {
      font-size: 1.1rem;
      margin: 0;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .logo-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--pc-accent-red);
      box-shadow: 0 0 10px var(--pc-accent-red);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.72rem;
      background: rgba(12, 29, 71, 0.9);
      border: 1px solid rgba(201, 148, 67, 0.5);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--pc-accent-red);
      box-shadow: 0 0 6px var(--pc-accent-red);
    }
    .status-pill.paused .status-dot {
      background: var(--pc-grey);
      box-shadow: none;
    }

    .status-text { margin: 0; }

    .tc-display {
      margin: 6px 0 10px;
      font-family: "SF Mono", "Roboto Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1.3rem;
      letter-spacing: 0.22em;
      padding: 10px 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, #0C1D47, #000436);
      border: 1px solid rgba(201, 148, 67, 0.7);
      text-align: center;
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 0.78rem;
    }

    .row-label {
      color: var(--pc-grey);
      min-width: 68px;
    }

    select, input[type="number"], input[type="text"] {
      background: rgba(0, 4, 54, 0.98);
      border-radius: 999px;
      border: 1px solid rgba(201, 148, 67, 0.7);
      padding: 5px 10px;
      color: var(--pc-light);
      font-size: 0.8rem;
      outline: none;
      appearance: none;
      -moz-appearance: none;
      -webkit-appearance: none;
    }

    select { padding-right: 22px; }

    .compact-input {
      width: 60px;
      text-align: center;
    }

    .hex-input {
      width: 90px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .time-inputs {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .time-inputs span.sep {
      font-size: 0.78rem;
      color: var(--pc-grey);
    }

    .flag-group {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .flag-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.72rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(172, 172, 172, 0.6);
      background: rgba(12, 29, 71, 0.9);
      cursor: pointer;
    }

    .flag-pill input {
      margin: 0;
    }

    .buttons-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 6px;
    }

    button {
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      padding: 6px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    #startBtn {
      background: var(--pc-accent-red);
      color: #fff;
      box-shadow: 0 0 12px rgba(255, 80, 80, 0.5);
      flex: 1;
    }

    #stopBtn {
      background: rgba(12, 29, 71, 1);
      color: var(--pc-light);
      border: 1px solid rgba(172, 172, 172, 0.6);
    }

    #resyncBtn {
      background: rgba(201, 148, 67, 0.12);
      color: var(--pc-gold);
      border: 1px solid rgba(201, 148, 67, 0.7);
      font-size: 0.78rem;
      padding: 5px 10px;
    }

    button:disabled {
      opacity: 0.4;
      box-shadow: none;
      cursor: default;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.7rem;
      color: var(--pc-grey);
      text-align: right;
    }

    #audioGate {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #audioGateInner {
      padding: 14px 18px;
      border-radius: 14px;
      background: rgba(0, 4, 54, 0.96);
      border: 1px solid rgba(201,148,67,0.7);
      text-align: center;
      max-width: 280px;
      color: var(--pc-light);
      box-shadow: 0 18px 45px rgba(0,0,0,0.7);
      font-size: 0.8rem;
    }

    #audioGateInner button {
      margin-top: 10px;
      background: var(--pc-accent-red);
      color: #fff;
      padding: 7px 16px;
      font-size: 0.82rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      box-shadow: 0 0 12px rgba(255, 80, 80, 0.5);
    }

    .hidden { display: none !important; }

    @media (max-width: 380px) {
      .tc-display {
        font-size: 1.15rem;
        letter-spacing: 0.18em;
      }
    }
  </style>
</head>
<body>
<div id="audioGate">
  <div id="audioGateInner">
    Audio freigeben
    <button id="audioGateBtn">Start</button>
  </div>
</div>

<div class="card">
  <div class="title-row">
    <h1><span class="logo-dot"></span>Phantomcrew LTC</h1>
    <div id="statusPill" class="status-pill paused">
      <div class="status-dot"></div>
      <p id="status" class="status-text">stopp</p>
    </div>
  </div>

  <div id="tcDisplay" class="tc-display">--:--:--:--</div>

  <div class="row">
    <div class="row-label">FPS</div>
    <select id="fps">
      <option>12</option>
      <option>23.976</option>
      <option>24</option>
      <option selected>25</option>
      <option>29.97</option>
      <option>30</option>
      <option>48</option>
      <option>50</option>
      <option>59.94</option>
      <option>60</option>
    </select>
  </div>

  <div class="row">
    <div class="row-label">Timezone</div>
    <select id="utcOffset" class="compact-input">
      <option value="-12">UTC-12</option>
      <option value="-11">UTC-11</option>
      <option value="-10">UTC-10</option>
      <option value="-9">UTC-9</option>
      <option value="-8">UTC-8</option>
      <option value="-7">UTC-7</option>
      <option value="-6">UTC-6</option>
      <option value="-5">UTC-5</option>
      <option value="-4">UTC-4</option>
      <option value="-3">UTC-3</option>
      <option value="-2">UTC-2</option>
      <option value="-1">UTC-1</option>
      <option value="0">UTC±0</option>
      <option value="1" selected>UTC+1</option>
      <option value="2">UTC+2</option>
      <option value="3">UTC+3</option>
      <option value="4">UTC+4</option>
      <option value="5">UTC+5</option>
      <option value="6">UTC+6</option>
      <option value="7">UTC+7</option>
      <option value="8">UTC+8</option>
      <option value="9">UTC+9</option>
      <option value="10">UTC+10</option>
      <option value="11">UTC+11</option>
      <option value="12">UTC+12</option>
      <option value="13">UTC+13</option>
      <option value="14">UTC+14</option>
    </select>
  </div>

  <div class="row">
    <div class="row-label">Offset ms</div>
    <input id="msOffset" type="number" step="10" value="0" class="compact-input">
  </div>

  <div class="row">
    <div class="row-label">User Bits</div>
    <div class="time-inputs">
      <select id="ubMode">
        <option value="off">aus</option>
        <option value="date">Datum + TZ</option>
        <option value="sceneTake">Scene/Take</option>
        <option value="custom">Custom</option>
      </select>
      <input id="ubHex" type="text" maxlength="8" placeholder="8 HEX" class="hex-input">
    </div>
  </div>

  <div class="row hidden" id="sceneRow">
    <div class="row-label">Scene/Take</div>
    <div class="time-inputs">
      <input id="sceneInput" type="number" min="0" step="1" placeholder="Scene" class="compact-input">
      <span class="sep">/</span>
      <input id="takeInput" type="number" min="0" step="1" placeholder="Take" class="compact-input">
    </div>
  </div>

  <div class="row">
    <div class="row-label">Flags</div>
    <div class="flag-group">
      <label class="flag-pill">
        <input id="dfFlag" type="checkbox">
        <span>DF</span>
      </label>
      <label class="flag-pill">
        <input id="cfFlag" type="checkbox">
        <span>CF</span>
      </label>
    </div>
  </div>

  <div class="row">
    <div class="row-label">Start</div>
    <div class="time-inputs">
      <input id="h" type="number" min="0" max="23" value="0" class="compact-input"><span class="sep">:</span>
      <input id="m" type="number" min="0" max="59" value="0" class="compact-input"><span class="sep">:</span>
      <input id="s" type="number" min="0" max="59" value="0" class="compact-input"><span class="sep">:</span>
      <input id="f" type="number" min="0" max="59" value="0" class="compact-input">
    </div>
  </div>

  <div class="buttons-row">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="resyncBtn" type="button">Jetzt</button>
  </div>

  <div class="hint">
    URL: <code>?fps=23.976&amp;utc=1&amp;ms=-80&amp;ub=date</code>
  </div>
</div>

<script>
(function() {
  let audioCtx = null;
  let scriptNode = null;
  let running = false;

  let fpsSignal = 25;
  let fpsTc = 25;

  let hours = 0, minutes = 0, seconds = 0, frames = 0;
  let utcOffset = 1;
  let msOffset = 0;

  let userBitsMode = "off";    // "off" | "date" | "sceneTake" | "custom"
  let userBitsHex = "";
  let sceneValue = "";
  let takeValue = "";
  let dropFrame = false;
  let colorFrame = false;

  let sampleRate = 48000;
  let bitRate = fpsSignal * 80;
  let bitDuration = 1.0 / bitRate;
  let timeInBit = 0.0;
  let bitIndex = 0;
  let phase = 1.0;
  let midTransitionDone = false;
  let currentFrameBits = new Array(80).fill(0);

  const statusEl = document.getElementById("status");
  const statusPill = document.getElementById("statusPill");
  const fpsSelect = document.getElementById("fps");
  const utcOffsetSelect = document.getElementById("utcOffset");
  const msOffsetInput = document.getElementById("msOffset");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const resyncBtn = document.getElementById("resyncBtn");
  const tcDisplay = document.getElementById("tcDisplay");

  const ubModeSelect = document.getElementById("ubMode");
  const ubHexInput = document.getElementById("ubHex");
  const sceneRow = document.getElementById("sceneRow");
  const sceneInput = document.getElementById("sceneInput");
  const takeInput = document.getElementById("takeInput");
  const dfFlag = document.getElementById("dfFlag");
  const cfFlag = document.getElementById("cfFlag");

  const audioGate = document.getElementById("audioGate");
  const audioGateBtn = document.getElementById("audioGateBtn");

  function logStatus(text, isRunning) {
    statusEl.textContent = text;
    if (isRunning) statusPill.classList.remove("paused");
    else statusPill.classList.add("paused");
  }

  function updateTimeInputs() {
    document.getElementById("h").value = hours;
    document.getElementById("m").value = minutes;
    document.getElementById("s").value = seconds;
    document.getElementById("f").value = frames;
  }

  function updateTcDisplay() {
    const pad2 = x => x.toString().padStart(2, "0");
    tcDisplay.textContent = `${pad2(hours)}:${pad2(minutes)}:${pad2(seconds)}:${pad2(frames)}`;
  }

  function setBcd(bits, value, unitIndices, tensIndices) {
    let units = value % 10;
    let tens = Math.floor(value / 10);
    for (let i = 0; i < unitIndices.length; i++) {
      bits[unitIndices[i]] = (units >> i) & 1;
    }
    for (let i = 0; i < tensIndices.length; i++) {
      bits[tensIndices[i]] = (tens >> i) & 1;
    }
  }

  function setUserNibble(bits, nibbleVal, bitIdxArray) {
    nibbleVal = nibbleVal & 0xF;
    for (let i = 0; i < 4; i++) {
      bits[bitIdxArray[i]] = (nibbleVal >> i) & 1;
    }
  }

  function setBit(bits, idx, val) {
    bits[idx] = val ? 1 : 0;
  }

  function updateUbInputsVisible() {
    ubHexInput.disabled = (userBitsMode !== "custom");
    ubHexInput.style.opacity = (userBitsMode === "custom") ? 1 : 0.4;

    if (userBitsMode === "sceneTake") {
      sceneRow.classList.remove("hidden");
    } else {
      sceneRow.classList.add("hidden");
    }
  }

  function getCurrentDateInfo() {
    const now = new Date();
    const offsetMs = (utcOffset * 3600 * 1000) + msOffset;
    const local = new Date(now.getTime() + offsetMs);

    return {
      year: local.getUTCFullYear() % 100,
      month: local.getUTCMonth() + 1,
      day: local.getUTCDate()
    };
  }

  function setBGFFlagsDate(bits) {
    const is25 = (Math.round(fpsTc) === 25);
    const bgf0Index = is25 ? 27 : 43;
    const bgf1Index = 58;
    const bgf2Index = is25 ? 43 : 59;

    setBit(bits, bgf0Index, 1);
    setBit(bits, bgf1Index, 1);
    setBit(bits, bgf2Index, 1);
  }

  function clearBGFFlags(bits) {
    const is25 = (Math.round(fpsTc) === 25);
    const bgf0Index = is25 ? 27 : 43;
    const bgf1Index = 58;
    const bgf2Index = is25 ? 43 : 59;
    setBit(bits, bgf0Index, 0);
    setBit(bits, bgf1Index, 0);
    setBit(bits, bgf2Index, 0);
  }

  function applyUserBits(bits, dateInfo) {
    // reset all BG nibbles to 0
    const bgNibbles = [
      [4,5,6,7],
      [12,13,14,15],
      [20,21,22,23],
      [28,29,30,31],
      [36,37,38,39],
      [44,45,46,47],
      [52,53,54,55],
      [60,61,62,63]
    ];
    bgNibbles.forEach(arr => setUserNibble(bits, 0x0, arr));
    clearBGFFlags(bits);

    if (userBitsMode === "off") return;

    if (userBitsMode === "custom") {
      let hex = (userBitsHex || "").toUpperCase().replace(/[^0-9A-F]/g, "");
      while (hex.length < 8) hex += "0";
      if (hex.length > 8) hex = hex.slice(0, 8);
      for (let i = 0; i < 8; i++) {
        const val = parseInt(hex[i], 16);
        const nib = isNaN(val) ? 0 : val;
        setUserNibble(bits, nib, bgNibbles[i]);
      }
      return;
    }

    if (userBitsMode === "sceneTake") {
      const s = Math.max(0, Math.min(999, parseInt(sceneValue || "0", 10) || 0));
      const t = Math.max(0, Math.min(999, parseInt(takeValue || "0", 10) || 0));

      const sH = Math.floor(s / 100);
      const sT = Math.floor((s % 100) / 10);
      const sU = s % 10;
      const tH = Math.floor(t / 100);
      const tT = Math.floor((t % 100) / 10);
      const tU = t % 10;

      setUserNibble(bits, sH, bgNibbles[0]); // BG1
      setUserNibble(bits, sT, bgNibbles[1]); // BG2
      setUserNibble(bits, sU, bgNibbles[2]); // BG3
      setUserNibble(bits, tH, bgNibbles[3]); // BG4
      setUserNibble(bits, tT, bgNibbles[4]); // BG5
      setUserNibble(bits, tU, bgNibbles[5]); // BG6
      // BG7/BG8 bleiben 0
      return;
    }

    if (userBitsMode === "date") {
      setBGFFlagsDate(bits);

      const d = dateInfo.day;
      const m = dateInfo.month;
      const y = dateInfo.year % 100;

      const dUnits = d % 10;
      const dTens  = Math.floor(d / 10);
      const mUnits = m % 10;
      const mTens  = Math.floor(m / 10);
      const yUnits = y % 10;
      const yTens  = Math.floor(y / 10);

      // BG1..6 -> DDMMYY
      setUserNibble(bits, dUnits, bgNibbles[0]); // BG1
      setUserNibble(bits, dTens,  bgNibbles[1]); // BG2
      setUserNibble(bits, mUnits, bgNibbles[2]); // BG3
      setUserNibble(bits, mTens,  bgNibbles[3]); // BG4
      setUserNibble(bits, yUnits, bgNibbles[4]); // BG5
      setUserNibble(bits, yTens,  bgNibbles[5]); // BG6

      // BG7/BG8: Timezone aktuell auf 0 (UTC±0000), um keine Probleme zu machen
      setUserNibble(bits, 0x0, bgNibbles[6]);
      setUserNibble(bits, 0x0, bgNibbles[7]);
    }
  }

  function buildFrameBits(h, m, s, f, fpsTcVal, dateInfo) {
    let bits = new Array(80).fill(0);

    // Timecode BCD
    setBcd(bits, f, [0,1,2,3], [8,9]);
    setBcd(bits, s, [16,17,18,19], [24,25,26]);
    setBcd(bits, m, [32,33,34,35], [40,41,42]);
    setBcd(bits, h, [48,49,50,51], [56,57]);

    // Flags
    bits[10] = dropFrame ? 1 : 0;
    bits[11] = colorFrame ? 1 : 0;

    // User Bits
    applyUserBits(bits, dateInfo);

    // Sync-Word
    const syncPattern = [0,0,1,1, 1,1,1,1, 1,1,1,1, 1,1,0,1];
    for (let i = 0; i < 16; i++) bits[64 + i] = syncPattern[i];

    // Parität (even number of 0s)
    let parityIndex = (fpsTcVal === 25) ? 59 : 27;
    bits[parityIndex] = 0;
    let zeroCount = 0;
    for (let i = 0; i < 80; i++) if (bits[i] === 0) zeroCount++;
    if (zeroCount % 2 === 1) bits[parityIndex] = 1;

    return bits;
  }

  function incrementTimecode() {
    frames++;
    if (frames >= fpsTc) {
      frames = 0;
      seconds++;
      if (seconds >= 60) {
        seconds = 0;
        minutes++;
        if (minutes >= 60) {
          minutes = 0;
          hours = (hours + 1) % 24;
        }
      }
    }
  }

  function resetBitstream() {
    bitRate = fpsSignal * 80;
    bitDuration = 1.0 / bitRate;
    timeInBit = 0.0;
    bitIndex = 0;
    phase = 1.0;
    midTransitionDone = false;
    const dateInfo = getCurrentDateInfo();
    currentFrameBits = buildFrameBits(hours, minutes, seconds, frames, fpsTc, dateInfo);
    updateTcDisplay();
  }

  function generateSample() {
    if (!running) return 0.0;
    const dt = 1.0 / sampleRate;
    timeInBit += dt;

    let currentBit = currentFrameBits[bitIndex];

    if (currentBit === 1 && !midTransitionDone && timeInBit >= bitDuration / 2) {
      phase = -phase;
      midTransitionDone = true;
    }

    if (timeInBit >= bitDuration) {
      timeInBit -= bitDuration;
      phase = -phase;
      bitIndex++;
      midTransitionDone = false;

      if (bitIndex >= 80) {
        bitIndex = 0;
        incrementTimecode();
        const dateInfoNow = getCurrentDateInfo();
        currentFrameBits = buildFrameBits(hours, minutes, seconds, frames, fpsTc, dateInfoNow);
        updateTcDisplay();
      }
    }
    return phase * 0.6;
  }

  function syncToClock() {
    const now = new Date();
    let baseMs =
      now.getUTCHours() * 3600 * 1000 +
      now.getUTCMinutes() * 60 * 1000 +
      now.getUTCSeconds() * 1000 +
      now.getUTCMilliseconds();

    baseMs += utcOffset * 3600 * 1000;
    baseMs += msOffset;

    const dayMs = 24 * 3600 * 1000;
    baseMs = ((baseMs % dayMs) + dayMs) % dayMs;

    let h = Math.floor(baseMs / (3600 * 1000));
    let rem = baseMs % (3600 * 1000);
    let m = Math.floor(rem / (60 * 1000));
    rem = rem % (60 * 1000);
    let s = Math.floor(rem / 1000);
    let ms = rem % 1000;

    let f = Math.floor((ms / 1000) * fpsSignal);
    if (f >= fpsTc) f = fpsTc - 1;

    hours = h;
    minutes = m;
    seconds = s;
    frames = f;

    updateTimeInputs();
    updateTcDisplay();
    resetBitstream();
  }

  function updateUrlFromState() {
    const params = new URLSearchParams(window.location.search);
    params.set("fps", fpsSelect.value);
    params.set("utc", utcOffset.toString());
    params.set("ms", msOffset.toString());
    params.set("ub", userBitsMode);
    if (userBitsMode === "custom") {
      params.set("ubhex", userBitsHex);
    } else {
      params.delete("ubhex");
    }
    if (userBitsMode === "sceneTake") {
      if (sceneValue !== "") params.set("scene", sceneValue);
      else params.delete("scene");
      if (takeValue !== "") params.set("take", takeValue);
      else params.delete("take");
    } else {
      params.delete("scene");
      params.delete("take");
    }
    params.set("df", dropFrame ? "1" : "0");
    params.set("cf", colorFrame ? "1" : "0");

    const newUrl = window.location.pathname + "?" + params.toString();
    window.history.replaceState({}, "", newUrl);
  }

  function applyFpsFromSelect() {
    const valStr = fpsSelect.value;
    const val = parseFloat(valStr);

    if (Math.abs(val - 23.976) < 0.001) {
      fpsSignal = 24000 / 1001;
      fpsTc = 24;
    } else if (Math.abs(val - 29.97) < 0.001) {
      fpsSignal = 30000 / 1001;
      fpsTc = 30;
    } else if (Math.abs(val - 59.94) < 0.001) {
      fpsSignal = 60000 / 1001;
      fpsTc = 60;
    } else {
      fpsSignal = val;
      fpsTc = Math.round(val);
    }
  }

  function initializeFromUrl() {
    const params = new URLSearchParams(window.location.search);

    const urlFps = params.get("fps");
    if (urlFps) {
      const options = Array.from(fpsSelect.options).map(o => o.value);
      if (options.includes(urlFps)) {
        fpsSelect.value = urlFps;
      }
    }
    applyFpsFromSelect();

    const urlUtc = params.get("utc");
    if (urlUtc !== null) {
      const val = parseFloat(urlUtc);
      if (!isNaN(val)) utcOffset = val;
    }
    utcOffsetSelect.value = utcOffset.toString();

    const urlMs = params.get("ms");
    if (urlMs !== null) {
      const valMs = parseFloat(urlMs);
      if (!isNaN(valMs)) msOffset = valMs;
    }
    msOffsetInput.value = msOffset.toString();

    const urlUb = params.get("ub");
    if (urlUb === "date" || urlUb === "custom" || urlUb === "sceneTake" || urlUb === "off") {
      userBitsMode = urlUb;
    } else {
      userBitsMode = "off";
    }
    ubModeSelect.value = userBitsMode;

    const urlUbHex = params.get("ubhex");
    if (urlUbHex) {
      userBitsHex = urlUbHex.toUpperCase().replace(/[^0-9A-F]/g, "").slice(0,8);
    }
    ubHexInput.value = userBitsHex;

    const urlScene = params.get("scene");
    if (urlScene) {
      sceneValue = urlScene.replace(/[^\d]/g, "");
      sceneInput.value = sceneValue;
    }

    const urlTake = params.get("take");
    if (urlTake) {
      takeValue = urlTake.replace(/[^\d]/g, "");
      takeInput.value = takeValue;
    }

    const urlDf = params.get("df");
    dropFrame = (urlDf === "1");
    dfFlag.checked = dropFrame;

    const urlCf = params.get("cf");
    colorFrame = (urlCf === "1");
    cfFlag.checked = colorFrame;

    updateUbInputsVisible();
  }

  function ensureAudioRunning() {
    if (audioCtx && audioCtx.state === "suspended") {
      audioCtx.resume().then(() => {
        audioGate.style.display = "none";
      });
    }
  }

  function startLTC() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      sampleRate = audioCtx.sampleRate;
      scriptNode = audioCtx.createScriptProcessor(1024, 0, 1);
      scriptNode.onaudioprocess = function(e) {
        let out = e.outputBuffer.getChannelData(0);
        for (let i = 0; i < out.length; i++) out[i] = generateSample();
      };
      scriptNode.connect(audioCtx.destination);
    } else {
      sampleRate = audioCtx.sampleRate;
    }

    applyFpsFromSelect();
    utcOffset = parseFloat(utcOffsetSelect.value) || 0;
    msOffset = parseFloat(msOffsetInput.value) || 0;

    syncToClock();
    running = true;
    ensureAudioRunning();

    startBtn.disabled = true;
    stopBtn.disabled = false;
    logStatus("läuft", true);
    updateUrlFromState();

    if (audioCtx.state === "suspended") {
      audioGate.style.display = "flex";
    }
  }

  function stopLTC() {
    running = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    logStatus("stopp", false);
  }

  // UI Events
  startBtn.addEventListener("click", startLTC);
  stopBtn.addEventListener("click", stopLTC);

  resyncBtn.addEventListener("click", function() {
    syncToClock();
    updateUrlFromState();
  });

  fpsSelect.addEventListener("change", function() {
    applyFpsFromSelect();
    updateUrlFromState();
    syncToClock();
    if (running) {
      resetBitstream();
      ensureAudioRunning();
    }
  });

  utcOffsetSelect.addEventListener("change", function() {
    utcOffset = parseFloat(this.value) || 0;
    updateUrlFromState();
    syncToClock();
    if (running) {
      resetBitstream();
      ensureAudioRunning();
    }
  });

  msOffsetInput.addEventListener("change", function() {
    msOffset = parseFloat(this.value) || 0;
    updateUrlFromState();
    syncToClock();
    if (running) {
      resetBitstream();
      ensureAudioRunning();
    }
  });

  ubModeSelect.addEventListener("change", function() {
    userBitsMode = this.value;
    updateUbInputsVisible();
    resetBitstream();
    updateUrlFromState();
  });

  ubHexInput.addEventListener("input", function() {
    userBitsHex = this.value.toUpperCase().replace(/[^0-9A-F]/g, "").slice(0,8);
    this.value = userBitsHex;
    resetBitstream();
    updateUrlFromState();
  });

  sceneInput.addEventListener("input", function() {
    sceneValue = this.value.replace(/[^\d]/g, "");
    this.value = sceneValue;
    if (userBitsMode === "sceneTake") {
      resetBitstream();
      updateUrlFromState();
    }
  });

  takeInput.addEventListener("input", function() {
    takeValue = this.value.replace(/[^\d]/g, "");
    this.value = takeValue;
    if (userBitsMode === "sceneTake") {
      resetBitstream();
      updateUrlFromState();
    }
  });

  dfFlag.addEventListener("change", function() {
    dropFrame = this.checked;
    resetBitstream();
    updateUrlFromState();
  });

  cfFlag.addEventListener("change", function() {
    colorFrame = this.checked;
    resetBitstream();
    updateUrlFromState();
  });

  audioGateBtn.addEventListener("click", function() {
    if (audioCtx) {
      audioCtx.resume().then(() => {
        audioGate.style.display = "none";
      });
    }
  });

  function handleFirstUserGesture() {
    ensureAudioRunning();
    window.removeEventListener("click", handleFirstUserGesture);
    window.removeEventListener("touchstart", handleFirstUserGesture);
  }
  window.addEventListener("click", handleFirstUserGesture, { once: true });
  window.addEventListener("touchstart", handleFirstUserGesture, { once: true });

  window.addEventListener("load", function() {
    initializeFromUrl();
    syncToClock();
    updateUrlFromState();
    startLTC();
  });
})();
</script>
</body>
</html>

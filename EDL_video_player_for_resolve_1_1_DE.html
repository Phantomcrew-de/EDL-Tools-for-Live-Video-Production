<!DOCTYPE html>
<html>
<head>
    <title>Video Player with Comments</title>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
<link rel="stylesheet" href="css/style.css">
       
	   <style>
        @media (max-width: 1024px) {
		body {
			padding-left: 5%;
			padding-right: 5%;
		}


        .video-player {
            width: 100%;
            margin-bottom: 20px;
            border-radius: 5px;
        }
		
 
        ul {
            list-style: none;
            padding: 0;
        }

    </style>
</head>
<body>
    <div>
	<h1>EDL Videoplayer</h1>
    <label for="edl-input">Videos hinzuf√ºgen</label>
        <input type="file" id="video-input" multiple onchange="loadVideos()">
                <br><br>
        <label>Aktuelles Video</label>
        
        
        <select id="video-select" onchange="changeVideo()"></select>
        <br>
        <video id="video-player" controls style="width:100%;"></video>
    </div>
    <div>
    <br>
               
        <form id="comment-form">
            <input type="text" id="comment-input" placeholder="Schreibe einen Kommentar...">
            <button id="add-button" type="button" onclick="addComment()">Hinzuf√ºgen</button>
        </form>
         
        <ul id="comment-list">
        </ul>

<br>
        <label>Importiere .edl Marken</label>
        <input type="file" id="edl-input" onchange="loadEDL()"><br><br>
        <button id="download-edl" onclick="downloadEDL()">üíæ Download EDL Marken</button> 
		<button id="clear-comments" onclick="clearComments()">üóëÔ∏è Alles l√∂schen</button><br>
    </div>

    <script>
        var videoPlayer = document.getElementById("video-player");
        var videoSelect = document.getElementById("video-select");
        var commentList = document.getElementById("comment-list");
        var downloadEDLButton = document.getElementById("download-edl");
        var videos = [];
        var currentVideo = 0;

        document.getElementById("comment-form").addEventListener("submit", function(event) {
            event.preventDefault();
            addComment();
        });
 // ... Existing script code ...
function clearComments() {
    // Sicherheitsabfrage
    if (confirm("Sind Sie sicher, dass Sie alle Kommentare l√∂schen m√∂chten?")) {
        if (videos && videos[currentVideo]) {
            videos[currentVideo].comments = [];
            updateCommentList();
        } else {
            console.error('Es ist derzeit kein Video ausgew√§hlt oder geladen.');
        }
    }
}



        function loadEDL() {
            var edlInput = document.getElementById("edl-input");
            var file = edlInput.files[0];
            var reader = new FileReader();

            reader.onload = function(e) {
                var contents = e.target.result;
                console.log("EDL file content:", contents); // Debug log
                parseEDL(contents);
            };

            reader.readAsText(file);
        }

         function parseTime(timeText) {
            var parts = timeText.split(":").map(Number);
            if (parts.length !== 4 || parts.some(isNaN)) {
                console.error("Invalid time format:", timeText);
                return "00:00:00:00";
            }
            return timeText; // Assuming the timeText is already in the correct format
        }

        function parseEDL(edlContent) {
            var lines = edlContent.split("\n");
            

            lines.forEach(line => {
                if (line.includes("|M:") && line.includes("|C:")) {
                    var commentText = line.split("|M:")[1].split("|")[0].trim();
                    var timeCode = line.split("|C:")[1].split(" ")[0].trim();
                    videos[currentVideo].comments.push({ comment: commentText, time: parseTime(timeCode) });
                }
            });

            updateCommentList();
        }

function parseTime(timeText) {
    var parts = timeText.split(":").map(Number);
    if (parts.length !== 4 || parts.some(isNaN)) {
        console.error("Invalid time format:", timeText);
        return timeText; // Return the original timeText if format is incorrect
    }
    var hours = parts[0];
    var minutes = parts[1];
    var seconds = parts[2];
    var frames = parts[3];
    // Adjust this to match your EDL's frame rate
    var totalSeconds = hours * 3600 + minutes * 60 + seconds + frames / 30;
    return formatTime(totalSeconds); // Convert total seconds back to time format
}


function parseEDL(edlContent) {
    var lines = edlContent.split("\n");

    var previousTimeCode = ""; // Variable to hold the previous line's timecode

    lines.forEach((line, index) => {
        // Check if the current line contains the timecode structure
        if (line.includes("V     C        ")) {
            // Extract the timecode, assuming it follows "V     C        "
            previousTimeCode = line.split("V     C        ")[1].split(" ")[0].trim();
        } else if (line.includes("|M:")) {
            // The current line has a comment, and the previous line had the timecode
            var commentText = line.split("|M:")[1].split("|")[0].trim();
            if (previousTimeCode && commentText) {
                videos[currentVideo].comments.push({ comment: commentText, time: previousTimeCode });
            }
            // Reset the previousTimeCode for the next use
            previousTimeCode = "";
        }
    });

    updateCommentList();
}





function formatTime(totalSeconds) {
    var hours = Math.floor(totalSeconds / 3600);
    var minutes = Math.floor((totalSeconds % 3600) / 60);
    var seconds = Math.floor(totalSeconds % 60);
    var frames = Math.floor((totalSeconds % 1) * 30); // Convert back to frames
    return twoDigits(hours) + ":" + twoDigits(minutes) + ":" + twoDigits(seconds) + ":" + twoDigits(frames);
}

function twoDigits(number) {
    return number < 10 ? "0" + number : number.toString();
}


        // ... Rest of the existing script code ...
        function loadVideos() {
            var videoInput = document.getElementById("video-input");
            var files = videoInput.files;
            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                var url = URL.createObjectURL(file);
                var video = {
                    url: url,
                    name: file.name,
                    comments: []
                };
                videos.push(video);
                var option = document.createElement("option");
                option.text = file.name;
                videoSelect.add(option);
            }
            changeVideo();
        }

        function changeVideo() {
            currentVideo = videoSelect.selectedIndex;
            videoPlayer.src = videos[currentVideo].url;
            updateCommentList();
        }

        function addComment() {
            var commentInput = document.getElementById("comment-input");
            var comment = commentInput.value.trim();
            var time = formatTime(videoPlayer.currentTime);

            if (comment) {
                videos[currentVideo].comments.push({ comment: comment, time: time });
                updateCommentList();
                commentInput.value = "";
            }
        }

        function updateCommentList() {
            commentList.innerHTML = "";
            videos[currentVideo].comments.forEach((commentObj, index) => {
                var listItem = document.createElement("li");
                listItem.appendChild(createEditableField("text", commentObj.comment, index, "comment"));
                listItem.appendChild(createEditableField("text", commentObj.time, index, "time"));
                listItem.appendChild(createButton("Go To", () => {
                    videoPlayer.currentTime = parseTime(commentObj.time);
                    videoPlayer.play();
                }));
                listItem.appendChild(createButton("Delete", () => {
                    videos[currentVideo].comments.splice(index, 1);
                    updateCommentList();
                }));
                commentList.appendChild(listItem);
            });
            downloadEDLButton.disabled = videos[currentVideo].comments.length === 0;
        }

        function createEditableField(type, value, index, field) {
            var input = document.createElement("input");
            input.type = type;
            input.value = value;
            input.addEventListener("input", function() {
                videos[currentVideo].comments[index][field] = this.value;
            });
            return input;
        }

        function createButton(text, onClick) {
            var button = document.createElement("button");
            button.textContent = text;
            button.onclick = onClick;
            return button;
        }

        function formatTime(time) {
            var hours = Math.floor(time / 3600);
            var minutes = Math.floor((time % 3600) / 60);
            var seconds = Math.floor(time % 60);
            var frames = Math.floor((time % 1) * 30); // Assuming 30 frames per second
            return (hours < 10 ? "0" + hours : hours) + ":" +
                   (minutes < 10 ? "0" + minutes : minutes) + ":" +
                   (seconds < 10 ? "0" + seconds : seconds) + ":" +
                   (frames < 10 ? "0" + frames : frames);
        }

        function parseTime(timeText) {
            var parts = timeText.split(":").map(parseFloat);
            var frames = parts[3] / 30; // Assuming 30 frames per second
            return parts[0] * 3600 + parts[1] * 60 + parts[2] + frames;
        }

        function downloadEDL() {
            var edlContent = `TITLE: PHANTOMCREW.DE Edit list for ${videos[currentVideo].name}\nFCM: NON-DROP FRAME\n\n`;
            videos[currentVideo].comments.forEach((comment, index) => {
                var timeCode = formatTime(parseTime(comment.time));
                edlContent += `00${index + 1}  001      V     C        ${timeCode} ${timeCode} ${timeCode} ${timeCode} \n |C:ResolveColorBlue |M:${comment.comment} |D:1\n\n`;
            });
            var blob = new Blob([edlContent], {type: "text/plain;charset=utf-8"});
            saveAs(blob, `${videos[currentVideo].name}.edl`);
        }
		// Referenzen (einmal am Anfang setzen)
var videoPlayer = document.getElementById("video-player");
var commentInput = document.getElementById("comment-input");
var addButton = document.getElementById("add-button");

// 1. Pausiere Video, wenn das Kommentarfeld im Fokus ist
commentInput.addEventListener("focus", function() {
    if (!videoPlayer.paused) videoPlayer.pause();
});

// 2. Starte Video wieder, wenn per Enter kommentiert oder Add gedr√ºckt wird
commentInput.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        addComment();
        event.preventDefault(); // damit das Formular nicht neu l√§dt
        setTimeout(() => {
            if (videoPlayer.paused) videoPlayer.play();
        }, 100); // leicht verz√∂gern f√ºr sauberes UX
    }
});
addButton.addEventListener("click", function() {
    setTimeout(() => {
        if (videoPlayer.paused) videoPlayer.play();
    }, 100);
});

// 3. GoTo-Button: Springe, dann pausiere 1 Sekunde, dann spiele weiter
function createButton(text, onClick) {
    var button = document.createElement("button");
    button.textContent = text;
    if (text === "Go To") {
        button.onclick = function() {
            // Speichere aktuellen Abspielstatus
            const wasPlaying = !videoPlayer.paused;
            onClick();
            videoPlayer.pause();
            setTimeout(() => {
                if (wasPlaying) videoPlayer.play();
            }, 1000); // 1 Sekunde Pause
        };
    } else {
        button.onclick = onClick;
    }
    return button;
}
commentInput.addEventListener("input", function() {
    if (!videoPlayer.paused) videoPlayer.pause();
});

    </script>

<!-- Info Button -->
<div id="info-icon" onclick="toggleInfoPopup()">‚ÑπÔ∏è</div>

<!-- Info Popup -->
<div id="info-popup">
  <div class="popup-content">
    <span class="close-btn" onclick="toggleInfoPopup()">‚ùå</span>
    <h2>√úber den EDL Videoplayer</h2>
    <p>Diese App erm√∂glicht es Ihnen:</p>
    <ul>
      <li>Mehrere Videos gleichzeitig zu laden</li>
      <li>Kommentare zu bestimmten Zeitpunkten hinzuzuf√ºgen</li>
      <li>EDL-Dateien zu importieren, um bereits vorhandene Marker zu laden</li>
      <li>Ihre Kommentare als EDL-Datei herunterzuladen</li>
    </ul>
    <p>Beginnen Sie, indem Sie Ihre Videos √ºber das Feld ‚ÄûVideos hinzuf√ºgen‚Äú hinzuf√ºgen. Sie k√∂nnen zwischen den Videos wechseln, Timecode basierte Kommentare einf√ºgen und die Liste als EDL-Marker-Datei exportieren.</p>
  </div>
</div>

<style>
  #info-icon {
    position: fixed;
    top: 10px;
    right: 10px;
    font-size: 24px;
    cursor: pointer;
    z-index: 999;
  }

  #info-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.85);
    color: white;
    z-index: 1000;
    padding: 40px;
    box-sizing: border-box;
  }

  .popup-content {
    max-width: 600px;
    margin: auto;
    background: #222;
    padding: 20px;
    border-radius: 10px;
    position: relative;
  }

  .popup-content h2 {
    margin-top: 0;
  }

  .close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 20px;
    cursor: pointer;
  }

  @media (max-width: 600px) {
    .popup-content {
      width: 90%;
    }
  }
</style>

<script>
  function toggleInfoPopup() {
    const popup = document.getElementById("info-popup");
    popup.style.display = popup.style.display === "block" ? "none" : "block";
  }
</script>

</body>
</html>

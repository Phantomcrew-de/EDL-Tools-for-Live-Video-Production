<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EDL Review Player ¬∑ YouTube & Dateien (Fix)</title>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
  <style>
    :root { --gap: 12px; --radius: 10px; --bg:#0f1220; --panel:#151a2d; --text:#f2f5ff; --muted:#a7b0c3; --warn:#ffb84d; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:20px; display:grid; grid-template-columns: 1fr auto; gap:var(--gap); align-items:center; border-bottom:1px solid #273055}
    h1{ font-size:20px; margin:0; }
    .panel{ background:var(--panel); padding:var(--gap); border-radius:var(--radius); }
    .stack{ display:grid; gap:var(--gap); }
    .row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"], select { background:#0e1426; color:var(--text); border:1px solid #2a355e; border-radius:8px; padding:10px 12px; min-width:240px; }
    button{ background:#2a355e; color:var(--text); border:0; border-radius:8px; padding:10px 14px; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    #player-wrap{ aspect-ratio:16/9; width:100%; background:black; border-radius:10px; overflow:hidden; position:relative }
    #player, #file-player{ position:absolute; inset:0; width:100%; height:100%; }
    #file-player{ display:none; background:black; }
    video{ width:100%; height:100%; }
    #comments li{ display:flex; gap:8px; align-items:center; padding:6px; }
    #comments input{ width:100%; background:#0e1426; color:var(--text); border:1px solid #2a355e; border-radius:6px; padding:6px 8px; }
    .top-right{ justify-self:end; display:flex; gap:8px; align-items:center; }
    .banner{ display:none; background:var(--warn); color:#111; padding:8px 12px; border-radius:8px; font-size:12px; }
    .badge{ font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0006; color:#fff; border-radius:6px; padding:2px 6px; }
    .btn-sm{ padding:6px 10px; line-height:1; }
    .tc{ width:120px; }
    .idx{ width:72px; }
    #comments input{ min-width:0; }

    footer{ padding:16px; text-align:center; color:var(--muted) }
    #logs { white-space:pre-wrap; font:12px ui-monospace,monospace; background:#090d1a; border:1px solid #273055; border-radius:8px; padding:8px; max-height:140px; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1 id="t_title">EDL Review Player ¬∑ YouTube & Dateien</h1>
      <div class="row">
        <label for="yt-url" id="t_ytlabel">YouTube URL (Video/Playlist/Live)</label>
        <input type="text" id="yt-url" placeholder="https://youtu.be/‚Ä¶ | /watch?v=‚Ä¶ | /playlist?list=‚Ä¶ | /live/‚Ä¶ | /shorts/‚Ä¶" />
        <button id="add-url" type="button">Hinzuf√ºgen</button>
        <button id="yt-selftest" type="button" title="L√§dt ein offizielles YouTube-Demo-Video zum Test">YT‚ÄëTest</button>
      </div>
      <div class="row">
        <label for="file-input" id="t_filelabel">Datei(en) hinzuf√ºgen</label>
        <input type="file" id="file-input" multiple accept="video/*" />
      </div>
      <div class="row">
        <label id="t_sourcelabel">Quelle w√§hlen</label>
        <select id="source-select"></select>
        <button id="prev" type="button" title="Vorheriges Playlist-Video">‚èÆÔ∏è</button>
        <button id="next" type="button" title="N√§chstes Playlist-Video">‚è≠Ô∏è</button>
        <span id="diag" class="badge" style="display:none"></span>
      </div>
      <div id="fileproto" class="banner">Hinweis: Du √∂ffnest die Datei √ºber <span class="badge">file://</span>. Der YouTube-Player kann so Fehler (<code>2</code>, <code>5</code>) werfen. Starte die Datei besser √ºber einen lokalen Webserver (z.‚ÄØB. <span class="badge">python -m http.server</span>) oder lege sie auf http(s).</div>
    </div>
    <div class="top-right">
      <button id="lang-toggle" type="button" title="Switch UI language">EN</button>
    </div>
  </header>

  <main class="stack" style="padding:16px">
    <section class="panel stack">
      <div id="player-wrap">
        <div id="player"></div>
        <video id="file-player" controls></video>
      </div>

      <form id="comment-form" class="row" onsubmit="return false">
        <input type="text" id="comment-input" placeholder="Kommentar hinzuf√ºgen‚Ä¶" />
        <button id="add-comment" type="button">Add</button>
        <span id="clip-info" style="font-size:12px;color:var(--muted)"></span>
      </form>

      <ul id="comments" class="panel" style="list-style:none; margin:0"></ul>

      <div class="row">
        <div class="stack" style="flex:1">
          <label id="t_edlimport">.edl Marker importieren</label>
          <input type="file" id="edl-input" />
        </div>
        <button id="download-edl" type="button">üíæ EDL exportieren</button>
        <button id="clear-comments" type="button">üóëÔ∏è Alle l√∂schen</button>
      </div>
      <div class="stack">
        <strong>Konsole</strong>
        <div id="logs"></div>
      </div>
    </section>
  </main>

  <footer>PHANTOMCREW ¬∑ EDL Tools</footer>

  <script>
  (function(){
    // safe log
    const $ = (id)=>document.getElementById(id);
    const logs = $('logs');
    const log = (...a)=>{ const line = a.map(x => (typeof x==='object'? JSON.stringify(x): String(x))).join(' '); logs.textContent += line + '\\n'; console.log(...a); };

    document.addEventListener('DOMContentLoaded', init);

    function init(){
      try {
        const urlInput=$('yt-url'), addUrlBtn=$('add-url'), ytTestBtn=$('yt-selftest'), fileInput=$('file-input'), selectEl=$('source-select');
        const prevBtn=$('prev'), nextBtn=$('next'), commentInput=$('comment-input'), addCommentBtn=$('add-comment');
        const commentsEl=$('comments'), downloadBtn=$('download-edl'), clearBtn=$('clear-comments');
        const edlInput=$('edl-input'), clipInfo=$('clip-info'), fileVideo=$('file-player'), langToggle=$('lang-toggle');
        const diag=$('diag'), fileBanner=$('fileproto');

        // State
        const sources=[]; // {type:'video'|'playlist'|'file', id, title, comments, commentsByIndex, fileUrl, fileName}
        let current=0; let ytPlayer=null; let ytReady=false; let usingFile=false; let pauseSuppressUntil=0;

        // Inject YT IFrame API
        const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.head.appendChild(tag);

        // i18n
        let LANG='de';
        const I18N = {
          de: { title:'EDL Review Player ¬∑ YouTube & Dateien', ytlabel:'YouTube URL (Video/Playlist/Live)', filelabel:'Datei(en) hinzuf√ºgen', sourcelabel:'Quelle w√§hlen', add:'Hinzuf√ºgen', addComment:'Kommentar hinzuf√ºgen‚Ä¶', edlimport:'.edl Marker importieren', export:'üíæ EDL exportieren', clear:'üóëÔ∏è Alle l√∂schen', prev:'Vorheriges Playlist-Video', next:'N√§chstes Playlist-Video' },
          en: { title:'EDL Review Player ¬∑ YouTube & Files', ytlabel:'YouTube URL (Video/Playlist/Live)', filelabel:'Add file(s)', sourcelabel:'Select source', add:'Add', addComment:'Add a comment‚Ä¶', edlimport:'Import .edl markers', export:'üíæ Export EDL', clear:'üóëÔ∏è Clear all', prev:'Previous playlist video', next:'Next playlist video' }
        };
        function applyLang(){
          const t = I18N[LANG];
          $('t_title').textContent=t.title; $('t_ytlabel').textContent=t.ytlabel; $('t_filelabel').textContent=t.filelabel; $('t_sourcelabel').textContent=t.sourcelabel;
          addUrlBtn.textContent=t.add; addCommentBtn.textContent=t.add; commentInput.placeholder=t.addComment; $('t_edlimport').textContent=t.edlimport; downloadBtn.textContent=t.export; clearBtn.textContent=t.clear; prevBtn.title=t.prev; nextBtn.title=t.next; langToggle.textContent=(LANG==='de'?'EN':'DE'); document.documentElement.lang=LANG;
        }
        applyLang();
        langToggle.addEventListener('click', ()=>{ LANG = LANG==='de' ? 'en' : 'de'; applyLang(); });

        // Helpers
        const two=n=>n<10?('0'+n):(''+n);
        function formatEDL(seconds){ const fps=30; const h=Math.floor(seconds/3600), m=Math.floor((seconds%3600)/60), s=Math.floor(seconds%60), f=Math.floor((seconds%1)*fps); return `${two(h)}:${two(m)}:${two(s)}:${two(f)}`; }
        function parseEDLTime(tc){ const [hh,mm,ss,ff]=tc.split(':').map(x=>parseInt(x,10)); const fps=30; if([hh,mm,ss,ff].some(isNaN)) return 0; return hh*3600+mm*60+ss+(ff/fps); }
        function getYouTubeId(u){
          try{
            const url=new URL(u); const host=url.hostname.replace(/^www\\./,''); const clean=v=>(v||'').replace(/[^a-zA-Z0-9_-]/g,'');
            const list=url.searchParams.get('list'); if(list) return {type:'playlist', id:clean(list)};
            if(host==='youtu.be'){ const id=clean(url.pathname.substring(1)); if(id) return {type:'video', id}; }
            const v=url.searchParams.get('v'); if(v) return {type:'video', id:clean(v)};
            if(host.endsWith('youtube.com')){ const p=url.pathname.split('/').filter(Boolean);
              if(p[0]==='live'&&p[1])   return {type:'video', id:clean(p[1])};
              if(p[0]==='shorts'&&p[1]) return {type:'video', id:clean(p[1])};
              if(p[0]==='playlist'){ const pl=url.searchParams.get('list'); if(pl) return {type:'playlist', id:clean(pl)}; }
              if(p[0]==='videoseries'){ const pl=url.searchParams.get('list'); if(pl) return {type:'playlist', id:clean(pl)}; }
            }
          }catch(e){}
          return null;
        }
        function isValidVideoId(id){ return /^[A-Za-z0-9_-]{11}$/.test(id||''); }

        function sourceLabel(src){ return src.title || (src.type==='file'?src.fileName: src.type==='video'?`YouTube ${src.id}`:`Playlist ${src.id}`); }
        function showFilePlayer(show){ usingFile=show; fileVideo.style.display=show?'block':'none'; $('player').style.display=show?'none':'block'; }

        // YT API callbacks
        window.onYouTubeIframeAPIReady=function(){
          const playerVars={ rel:0, modestbranding:1, iv_load_policy:3, enablejsapi:1, playsinline:1 };
          if(location.protocol.startsWith('http')){ playerVars.origin=location.origin; } else { fileBanner.style.display='block'; }
          ytPlayer=new YT.Player('player',{ width:'100%', height:'100%', playerVars, events:{ onReady:onYTReady, onStateChange:onYTState, onError:onYTError } });
          log('YT API ready, origin=', playerVars.origin||'none');
        };
        function onYTReady(){ ytReady=true; log('YT ready'); if(sources[current] && (sources[current].type==='video'||sources[current].type==='playlist')) cueCurrent(); }
        function onYTState(){ updateTitleFromYT(); updateClipInfo(); }
        function onYTError(e){ const code=e?.data; if(diag){ diag.style.display='inline-block'; diag.textContent='YT err '+code; } log('YT error', code); if(location.protocol==='file:') fileBanner.style.display='block'; }
        function updateTitleFromYT(){ try{ const data=ytPlayer?.getVideoData?.(); const title=data?.title||''; if(sources[current] && title && !sources[current].title){ sources[current].title=title; if(selectEl.options[current]) selectEl.options[current].text=sourceLabel(sources[current]); } }catch(e){ log('updateTitleFromYT err', e); } }
        function updateClipInfo(){ if(usingFile||!ytPlayer) return; const idx=ytPlayer.getPlaylistIndex?.(); const list=ytPlayer.getPlaylist?.()&&ytPlayer.getPlaylist(); clipInfo.textContent=(typeof idx==='number' && list && list.length)?`Playlist-Clip ${idx+1} / ${list.length}`:''; }

        // add URL
        function addSourceFromUrl(u){
          const meta=getYouTubeId(u);
          if(!meta){ alert(LANG==='de'?'Ung√ºltige YouTube-URL':'Invalid YouTube URL'); return; }
          if(diag){ diag.style.display='inline-block'; diag.textContent=(meta.type==='video'?'VID:':'PL:')+meta.id; }
          if(meta.type==='video' && !isValidVideoId(meta.id)){ alert(LANG==='de'?'Ung√ºltige Video-ID':'Invalid video ID'); return; }
          sources.push(meta.type==='video'? {type:'video',id:meta.id,title:'',comments:[]} : {type:'playlist',id:meta.id,title:'',commentsByIndex:{}});
          const opt=document.createElement('option'); opt.textContent=sourceLabel(sources[sources.length-1]); selectEl.add(opt);
          if(sources.length===1){ selectEl.selectedIndex=0; current=0; cueCurrent(); }
        }
        addUrlBtn.addEventListener('click',()=>{ const u=urlInput.value.trim(); if(!u) return; addSourceFromUrl(u); urlInput.value=''; cueCurrent(); });
        urlInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); addUrlBtn.click(); }});

        // yt self-test
        ytTestBtn.addEventListener('click',()=>{
          sources.push({type:'video', id:'M7lc1UVf-VE', title:'YouTube IFrame API Demo', comments:[]});
          const opt=document.createElement('option'); opt.textContent=sourceLabel(sources[sources.length-1]); selectEl.add(opt);
          selectEl.selectedIndex=sources.length-1; current=sources.length-1; cueCurrent();
        });

        // files
        fileInput.addEventListener('change',()=>{
          if(fileInput.files?.length){
            for(const f of fileInput.files){
              const url=URL.createObjectURL(f);
              sources.push({type:'file', id:url, fileUrl:url, fileName:f.name, title:f.name, comments:[]});
              const opt=document.createElement('option'); opt.textContent=sourceLabel(sources[sources.length-1]); selectEl.add(opt);
            }
            if(selectEl.selectedIndex<0){ selectEl.selectedIndex=0; current=0; }
            cueCurrent();
          }
        });

        // select change
        selectEl.addEventListener('change',()=>{ current=selectEl.selectedIndex; cueCurrent(); });

        // prev/next
        prevBtn.addEventListener('click',()=>{ const src=sources[current]; if(src?.type==='playlist'){ try{ ytPlayer.previousVideo(); }catch(e){ log('prev err', e);} } });
        nextBtn.addEventListener('click',()=>{ const src=sources[current]; if(src?.type==='playlist'){ try{ ytPlayer.nextVideo(); }catch(e){ log('next err', e);} } });

        // cue
        function cueCurrent(){
          const src=sources[current]; if(!src) return;
          if(src.type==='file'){
            showFilePlayer(true); ytPlayer?.stopVideo?.(); fileVideo.src=src.fileUrl; fileVideo.pause(); updateCommentList(); return;
          }
          if(!ytReady||!ytPlayer){ log('cue: yt not ready'); return; }
          showFilePlayer(false);
          try{
            if(src.type==='video'){
              if(!isValidVideoId(src.id)){ alert('Ung√ºltige Video-ID: '+src.id); return; }
              ytPlayer.cueVideoById({videoId:src.id});
              setTimeout(()=>{ ytPlayer.pauseVideo?.(); updateTitleFromYT(); }, 400);
            } else {
              ytPlayer.cuePlaylist({ listType:'playlist', list:src.id, index:0 });
              setTimeout(()=>{ ytPlayer.pauseVideo?.(); updateClipInfo(); updateTitleFromYT(); }, 600);
            }
          }catch(err){ log('cue error', err); if(diag){ diag.style.display='inline-block'; diag.textContent='cue error'; } }
          updateCommentList();
        }

        // comments
        function currentComments(){ const src=sources[current]; if(!src) return []; if(src.type==='video'||src.type==='file') return src.comments; const out=[]; const by=src.commentsByIndex||{}; Object.keys(by).sort((a,b)=>a-b).forEach(k=>{ (by[k]||[]).forEach(c=>out.push(c)); }); return out; }
        function updateCommentList(){ commentsEl.innerHTML=''; const src=sources[current]; if(!src) return; const items=currentComments(); items.forEach((c,i)=>commentsEl.appendChild(formatCommentItem(c,i, src.type==='playlist'))); downloadBtn.disabled=items.length===0; }
        function formatCommentItem(obj, idx, isPlaylist){ const li=document.createElement('li'); const text=document.createElement('input'); text.type='text'; text.value=obj.comment||''; text.addEventListener('input',()=>{ obj.comment=text.value; hardPause(); }); const time=document.createElement('input'); time.type='text'; time.value=obj.time||'00:00:00:00'; time.addEventListener('input',()=>{ obj.time=time.value; }); const gotoBtn=document.createElement('button'); gotoBtn.type='button'; gotoBtn.textContent='Go To'; gotoBtn.onclick=()=>{ const seconds=parseEDLTime(obj.time||'00:00:00:00'); const src=sources[current]; if(src.type==='playlist'){ const targetIndex=obj.index||0; ytPlayer.playVideoAt(targetIndex); setTimeout(()=>{ ytPlayer.seekTo(seconds,true); ytPlayer.pauseVideo(); },700);} else if(src.type==='video'){ const was=ytPlayer.getPlayerState()===1; ytPlayer.seekTo(seconds,true); if(!was) ytPlayer.pauseVideo(); } else { fileVideo.currentTime=seconds; fileVideo.pause(); } }; const delBtn=document.createElement('button'); delBtn.type='button'; delBtn.textContent='Delete'; delBtn.onclick=()=>removeCommentAt(idx); if(isPlaylist){ const idxInput=document.createElement('input'); idxInput.type='text'; idxInput.value=(obj.index?obj.index+1:1).toString(); idxInput.title='Playlist-Index (1-basiert)'; idxInput.addEventListener('input',()=>{ const v=parseInt(idxInput.value,10)-1; if(!isNaN(v)) obj.index=Math.max(0,v); }); li.append(text,time,idxInput,gotoBtn,delBtn); } else { li.append(text,time,gotoBtn,delBtn); } return li; }
        function removeCommentAt(globalIndex){ const src=sources[current]; if(!src) return; if(src.type==='video'||src.type==='file'){ src.comments.splice(globalIndex,1); } else { let count=0; outer: for(const k of Object.keys(src.commentsByIndex||{}).sort((a,b)=>a-b)){ const arr=src.commentsByIndex[k]||[]; for(let i=0;i<arr.length;i++){ if(count===globalIndex){ arr.splice(i,1); break outer; } count++; } } } updateCommentList(); }
        function addComment(){ const src=sources[current]; if(!src) return; const text=commentInput.value.trim(); if(!text) return; hardPause(); const seconds = src.type==='file' ? (fileVideo.currentTime||0) : (ytPlayer?.getCurrentTime?.()||0); const tc=formatEDL(seconds); if(src.type==='video'||src.type==='file'){ src.comments.push({ comment:text, time:tc }); } else { const idx= ytPlayer?.getPlaylistIndex?.() ?? 0; const k=String(idx); if(!src.commentsByIndex) src.commentsByIndex={}; if(!src.commentsByIndex[k]) src.commentsByIndex[k]=[]; src.commentsByIndex[k].push({ comment:text, time:tc, index:idx }); } commentInput.value=''; updateCommentList(); }
        
// Nach Kommentar wieder Play starten
function resumePlayback() {
  const src = sources[current];
  if (!src) return;
  if (src.type === 'file') {
    fileVideo.play?.();
  } else if (ytPlayer && ytPlayer.playVideo) {
    try { ytPlayer.playVideo(); } catch(e) { log('resume error', e); }
  }
}

// Wenn man einen Kommentar hinzuf√ºgt (Button oder Enter)
addCommentBtn.addEventListener('click', () => { addComment(); resumePlayback(); });
commentInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault(); addComment(); resumePlayback(); }
});


        function hardPause(){ if (Date.now() < pauseSuppressUntil) return; const src=sources[current]; if(!src) return; if(src.type==='file'){ if(!fileVideo.paused) fileVideo.pause(); } else if(ytPlayer && ytPlayer.pauseVideo){ try{ ytPlayer.pauseVideo(); }catch(e){} } }
        commentInput.addEventListener('focus', hardPause); commentInput.addEventListener('input', hardPause);
$('comment-form').addEventListener('pointerdown', hardPause, {capture:true});

        clearBtn.addEventListener('click', ()=>{ const msg= LANG==='de'? 'Alle Kommentare f√ºr die aktuelle Quelle l√∂schen?' : 'Delete all comments for the current source?'; if(!confirm(msg)) return; const src=sources[current]; if(!src) return; if(src.type==='video'||src.type==='file') src.comments=[]; else src.commentsByIndex={}; updateCommentList(); });

        edlInput.addEventListener('change', ()=>{ const file=edlInput.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=e=>parseEDL(e.target.result); reader.readAsText(file); });
        function parseEDL(content){ const src=sources[current]; if(!src) return; const lines=content.split(/\\r?\\n/); let lastTime=''; for(const line of lines){ if(line.includes('V     C        ')){ lastTime=line.split('V     C        ')[1].split(' ')[0].trim(); } else if(line.includes('|M:')){ const commentText=line.split('|M:')[1].split('|')[0].trim(); if(!lastTime) continue; if(src.type==='video'||src.type==='file'){ src.comments.push({ comment:commentText, time:lastTime }); } else { let idx= ytPlayer?.getPlaylistIndex?.() ?? 0; const m=commentText.match(/^\\s*\\[#(\\d+)\\]\\s*(.*)$/); const pure=m? m[2] : commentText; if(m){ idx=Math.max(0, parseInt(m[1],10)-1);} const k=String(idx); if(!src.commentsByIndex) src.commentsByIndex={}; if(!src.commentsByIndex[k]) src.commentsByIndex[k]=[]; src.commentsByIndex[k].push({ comment:pure, time:lastTime, index:idx }); } lastTime=''; } } updateCommentList(); }
        downloadBtn.addEventListener('click', ()=>{ const src=sources[current]; if(!src) return; const title= src.title || (src.type==='file'? src.fileName : src.id); let edl=`TITLE: PHANTOMCREW.DE Edit list for ${title}\\nFCM: NON-DROP FRAME\\n\\n`; let i=1; const write=(c)=>{ const tc=formatEDL(parseEDLTime(c.time)); edl+=`00${two(i++)}  001      V     C        ${tc} ${tc} ${tc} ${tc} \\n |C:ResolveColorBlue |M:${c.comment} |D:1\\n\\n`; }; if(src.type==='video'||src.type==='file'){ for(const c of src.comments){ write(c); } } else { for(const c of currentComments()){ const tc=formatEDL(parseEDLTime(c.time)); const idxTag= typeof c.index==='number'? `[#${(c.index+1)}] ` : ''; edl+=`00${two(i++)}  001      V     C        ${tc} ${tc} ${tc} ${tc} \\n |C:ResolveColorBlue |M:${idxTag}${c.comment} |D:1\\n\\n`; } } const blob=new Blob([edl],{type:'text/plain;charset=utf-8'}); const safeName=(title||'session').replace(/[^a-z0-9_\\-]+/gi,'_'); saveAs(blob, `${safeName}.edl`); });

        // final: confirm UI is wired
        log('UI wired. Ready.');
      } catch (e) {
        logs.textContent += 'FATAL JS-Fehler: '+ (e && (e.stack || e.message || e)) + '\\n';
      }
    }
  })();
  </script>
</body>
</html>

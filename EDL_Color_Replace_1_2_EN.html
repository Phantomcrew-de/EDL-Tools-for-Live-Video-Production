<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <link rel="stylesheet" href="css/style.css">
  <title>EDL Color Replacer 2.0</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #121212;
      color: #ffffff;
    }
    #colorContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .colorCircle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      transition: transform 0.2s ease;
      cursor: pointer;
      position: relative;
    }
    .colorCircle:hover {
      transform: scale(1.2);
    }
    .tooltip {
      position: absolute;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 5px;
      display: none;
      color: #000;
      white-space: nowrap;
      z-index: 5;
    }
    .colorCircle:hover .tooltip {
      display: block;
    }
    input[type="file"] {
      margin-bottom: 20px;
    }
    #entryTable {
      margin-top: 30px;
      width: 100%;
      border-collapse: collapse;
    }
    #entryTable th, #entryTable td {
      border: 1px solid #555;
      padding: 8px;
      text-align: left;
    }
    .color-box {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
      cursor: pointer;
    }
    #popupContainer, .info-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e1e1e;
      color: #fff;
      border: 1px solid #555;
      padding: 20px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #popupContainer {
      display: none;
    }
    .color-option {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
      cursor: pointer;
    }
    .color-swatch {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    #downloadBtn {
      margin-top: 20px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
  <h1>EDL Color Replacer 2.0</h1>
  <input type="file" id="fileInput" accept=".edl">
  <div id="colorContainer"></div>
  <button id="downloadBtn" style="display:none">ðŸ“‚ Download modified EDL</button>
  <div id="popupContainer" class="select-popup"></div>
  <table id="entryTable" style="display:none">
    <thead>
      <tr><th>Color</th><th>Timecode</th><th>Comment</th></tr>
    </thead>
    <tbody id="entryBody"></tbody>
  </table>

  <script>
    const colorMap = {
      ResolveColorBlue:'#007FE3', ResolveColorCyan:'#01B7BA', ResolveColorGreen:'#4EC057',
      ResolveColorYellow:'#F3D241', ResolveColorRed:'#ED3023', ResolveColorPink:'#F199B0',
      ResolveColorFuchsia:'#FF44C8', ResolveColorLavender:'#C299FF', ResolveColorSky:'#8AD3FF',
      ResolveColorSand:'#D6C199', ResolveColorCocoa:'#6E5143', ResolveColorPurple:'#9B59B6',
      ResolveColorRose:'#F78DA7', ResolveColorMint:'#B9E269', ResolveColorLemon:'#FFF176',
      ResolveColorCream:'#F5EBE1'
    };

    let edlText = '', modifiedEDL = '', entries = [];

    let originalFilename = '';

document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      originalFilename = file.name.replace(/\.edl$/i, '');
  const reader = new FileReader();
      reader.onload = function(event) {
        edlText = event.target.result;
        modifiedEDL = edlText;
        parseMarkers();
        renderColorCircles();
        renderEntryTable();
        document.getElementById('downloadBtn').style.display = 'inline-block';
      };
      reader.readAsText(file);
    });

    function parseMarkers() {
      entries = [];
      const lines = modifiedEDL.split('\n');
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (line.includes('|C:ResolveColor')) {
          const timeLine = lines[i - 1];
          const timeMatch = timeLine.match(/(\d{2}:\d{2}:\d{2}:\d{2})/);
          const colorMatch = line.match(/\|C:(ResolveColor\w+)/);
          const commentMatch = line.match(/\|M:([^|]+)/);
          if (timeMatch && colorMatch) {
            entries.push({
              original: line,
              timecode: timeMatch[1],
              comment: commentMatch ? commentMatch[1].trim() : '',
              color: colorMatch[1]
            });
          }
        }
      }
    }

    function renderColorCircles() {
      const container = document.getElementById('colorContainer');
      container.innerHTML = '';
      const countMap = {};
      entries.forEach(e => countMap[e.color] = (countMap[e.color] || 0) + 1);
      for (const [color, count] of Object.entries(countMap)) {
        const div = document.createElement('div');
        div.className = 'colorCircle';
        div.style.backgroundColor = colorMap[color];
        div.textContent = count;
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.textContent = color;
        div.appendChild(tooltip);
        div.addEventListener('click', () => showColorPopup(color));
        container.appendChild(div);
      }
    }

    function renderEntryTable() {
      const tbody = document.getElementById('entryBody');
      tbody.innerHTML = '';
      entries.forEach((entry, index) => {
        const row = document.createElement('tr');
        const colorCell = document.createElement('td');
        const colorBox = document.createElement('div');
        colorBox.className = 'color-box';
        colorBox.style.backgroundColor = colorMap[entry.color];
        colorBox.title = entry.color;
        colorBox.addEventListener('click', () => showColorPopup(entry.color, index));
        colorCell.appendChild(colorBox);
        row.appendChild(colorCell);

        const timeCell = document.createElement('td');
        timeCell.textContent = entry.timecode;
        row.appendChild(timeCell);

        const commentCell = document.createElement('td');
        commentCell.textContent = entry.comment;
        row.appendChild(commentCell);

        tbody.appendChild(row);
      });
      document.getElementById('entryTable').style.display = 'table';
    }

    function showColorPopup(currentColor, entryIndex = null) {
      const popup = document.getElementById('popupContainer');
      popup.innerHTML = '<h3>Choose new color</h3>';
      for (const [color, hex] of Object.entries(colorMap)) {
        const option = document.createElement('div');
        option.className = 'color-option';
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = hex;
        const label = document.createElement('span');
        label.textContent = color;
        option.appendChild(swatch);
        option.appendChild(label);
        option.addEventListener('click', () => {
          if (entryIndex !== null) {
            entries[entryIndex].color = color;
          } else {
            entries.forEach(e => { if (e.color === currentColor) e.color = color; });
          }
          updateEDLText();
          renderColorCircles();
          renderEntryTable();
          popup.style.display = 'none';
        });
        popup.appendChild(option);
      }
      popup.style.display = 'block';
    }

    function updateEDLText() {
      let lines = edlText.split('\n');
      entries.forEach(entry => {
        lines = lines.map(line => {
          if (line === entry.original) {
            return line.replace(/ResolveColor\w+/, entry.color);
          }
          return line;
        });
      });
      modifiedEDL = lines.join('\n');
    }

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const blob = new Blob([modifiedEDL], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = originalFilename + '_modified.edl';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>

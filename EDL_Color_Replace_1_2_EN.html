<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<link href="css/style.css" rel="stylesheet"/>
<title>EDL Color Replacer</title>
<style>
  body {
    font-family: Arial, sans-serif;
    color: #ffffff;
    padding: 20px;
    padding-left: 25%;
    padding-right: 25%;
  }

  @media (max-width: 1024px) {
    body {
      padding-left: 5%;
      padding-right: 5%;
    }
  }

  #colorContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 20px;
  }

  .colorCircle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: bold;
    transition: transform 0.2s ease;
    cursor: pointer;
    position: relative;
  }

  .colorCircle:hover {
    transform: scale(1.2);
  }

  .tooltip {
    position: absolute;
    top: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    border: 1px solid #ccc;
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 5px;
    color: #000;
    white-space: nowrap;
    z-index: 1004;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .colorCircle:hover .tooltip {
    visibility: visible;
    opacity: 1;
  }

  input[type="file"] {
    margin-bottom: 1px;
  }

  #entryTable {
    margin-top: 1px;
    width: 100%;
    border-collapse: collapse;
    border-spacing: 0;
  }

  #entryTable th,
  #entryTable td {
    border: 1px solid #555;
    padding: 3px; /* 3px Abstand */
    text-align: left;
  }

  #entryTable input[type="text"] {
    background-color: #111;
    color: #fff;
    border: none;
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    box-sizing: border-box;
  }

  .color-box {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    cursor: pointer;
  }

  #popupContainer,
  .info-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #1e1e1e;
    color: #fff;
    border: 1px solid #555;
    padding: 20px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  }

  #popupContainer {
    display: none;
  }

  .color-option {
    display: flex;
    align-items: center;
    gap: 1px;
    margin-bottom: 5px;
    cursor: pointer;
  }

  .color-swatch {
    width: 20px;
    height: 20px;
    border-radius: 50%;
  }

  #downloadBtn {
    margin-top: 20px;
    padding: 10px 20px;
  }
.colorCircle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: bold;
    transition: transform 0.2s ease;
    cursor: pointer;
    position: relative;
    z-index: 1;
  }

  .colorCircle:hover {
    transform: scale(1.2);
    z-index: 1002;
  }
</style>

</head>
<body>
<div id="infoBtn" style="position: fixed; top: 10px; right: 10px; cursor: pointer; font-size: 24px; color: white; z-index: 1001;" title="Info">‚ÑπÔ∏è</div>
<div id="infoPopup" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background-color: #1e1e1e; color: white; padding: 20px; border: 1px solid #555; border-radius: 8px;
  max-width: 400px; z-index: 1002; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
<h2>What does this tool do?</h2>
<p>This tool helps you visualize and change marker colors in DaVinci Resolve EDL files (.edl).</p>
<ul>
<li>Upload an .edl file</li>
<li>Click on a color to replace it</li>
<li>Download the modified file</li>
</ul>
<button onclick="document.getElementById('infoPopup').style.display='none'">Close</button>
</div>
<h1>EDL Color Replacer</h1>
<input accept=".edl" id="fileInput" type="file"/>
<div id="colorContainer"></div>
<button id="downloadBtn" style="display:none">üíæ Download modified EDL</button>
<div class="select-popup" id="popupContainer"></div>
<table id="entryTable" style="display:none">
<thead>
<tr><th>Color</th><th>Timecode</th><th>Comment</th></tr>
</thead>
<tbody id="entryBody"></tbody>
</table>
<script>
    const colorMap = {
      ResolveColorBlue:'#007FE3', ResolveColorCyan:'#01B7BA', ResolveColorGreen:'#4EC057',
      ResolveColorYellow:'#F3D241', ResolveColorRed:'#ED3023', ResolveColorPink:'#F199B0',
      ResolveColorFuchsia:'#FF44C8', ResolveColorLavender:'#C299FF', ResolveColorSky:'#8AD3FF',
      ResolveColorSand:'#D6C199', ResolveColorCocoa:'#6E5143', ResolveColorPurple:'#9B59B6',
      ResolveColorRose:'#F78DA7', ResolveColorMint:'#B9E269', ResolveColorLemon:'#FFF176',
      ResolveColorCream:'#F5EBE1'
    };

    let edlText = '', modifiedEDL = '', entries = [];

    let originalFilename = '';

document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      originalFilename = file.name.replace(/\.edl$/i, '');
  const reader = new FileReader();
      reader.onload = function(event) {
        edlText = event.target.result;
        modifiedEDL = edlText;
        parseMarkers();
        renderColorCircles();
        renderEntryTable();
        document.getElementById('downloadBtn').style.display = 'inline-block';
      };
      reader.readAsText(file);
    });

    
function parseMarkers() {
  entries = [];
  const lines = modifiedEDL.split('\n');
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i];
    if (line.includes('|C:ResolveColor')) {
      const timeLine = lines[i - 1];
      const timeMatch = timeLine.match(/(\d{2}:\d{2}:\d{2}:\d{2})/);
      const colorMatch = line.match(/\|C:(ResolveColor\w+)/);
      const commentMatch = line.match(/\|M:([^|]+)/);
      if (timeMatch && colorMatch) {
        entries.push({
          timeIndex: i - 1,
          markerIndex: i,
          timecode: timeMatch[1],
          comment: commentMatch ? commentMatch[1].trim() : '',
          color: colorMatch[1]
        });
      }
    }
  }
}


    function renderColorCircles() {
      const container = document.getElementById('colorContainer');
      container.innerHTML = '';
      const countMap = {};
      entries.forEach(e => countMap[e.color] = (countMap[e.color] || 0) + 1);
      for (const [color, count] of Object.entries(countMap)) {
        const div = document.createElement('div');
        div.className = 'colorCircle';
        div.style.backgroundColor = colorMap[color];
        div.textContent = count;
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.textContent = color;
        div.appendChild(tooltip);
        div.addEventListener('click', () => showColorPopup(color));
        container.appendChild(div);
      }
    }

    
function renderEntryTable() {
  const tbody = document.getElementById('entryBody');
  tbody.innerHTML = '';
  entries.forEach((entry, index) => {
    const row = document.createElement('tr');

    // Farbkreis
    const colorCell = document.createElement('td');
    const colorBox = document.createElement('div');
    colorBox.className = 'color-box';
    colorBox.style.backgroundColor = colorMap[entry.color];
    colorBox.title = entry.color;
    colorBox.addEventListener('click', () => showColorPopup(entry.color, index));
    colorCell.appendChild(colorBox);
    row.appendChild(colorCell);

    // Timecode-Eingabefeld
    const timeCell = document.createElement('td');
    const timeInput = document.createElement('input');
    timeInput.type = 'text';
    timeInput.value = entry.timecode;
    timeInput.style.width = '100%';
    timeInput.addEventListener('input', (e) => {
      entries[index].timecode = e.target.value;
      updateEDLText();
    });
    timeCell.appendChild(timeInput);
    row.appendChild(timeCell);

    // Kommentar-Eingabefeld
    const commentCell = document.createElement('td');
    const commentInput = document.createElement('input');
    commentInput.type = 'text';
    commentInput.value = entry.comment;
    commentInput.style.width = '100%';
    commentInput.addEventListener('input', (e) => {
      entries[index].comment = e.target.value;
      updateEDLText();
    });
    commentCell.appendChild(commentInput);
    row.appendChild(commentCell);

    tbody.appendChild(row);
  });
  document.getElementById('entryTable').style.display = 'table';
}


function showColorPopup(currentColor, entryIndex = null) {
  const popup = document.getElementById('popupContainer');
  popup.innerHTML = `
    <div id="popupHeader" style="display: flex; justify-content: space-between; align-items: center; cursor: move;">
      <h3 style="margin: 0;">Choose new color</h3>
      <button id="closePopupBtn" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úñ</button>
    </div>
  `;

  // Build list of colors
  for (const [color, hex] of Object.entries(colorMap)) {
    const option = document.createElement('div');
    option.className = 'color-option';
    const swatch = document.createElement('div');
    swatch.className = 'color-swatch';
    swatch.style.backgroundColor = hex;
    const label = document.createElement('span');
    label.textContent = color;

    option.appendChild(swatch);
    option.appendChild(label);

    option.addEventListener('click', () => {
      if (entryIndex !== null) {
        entries[entryIndex].color = color;
      } else {
        entries.forEach(e => { if (e.color === currentColor) e.color = color; });
      }
      updateEDLText();
      renderColorCircles();
      renderEntryTable();
      popup.style.display = 'none';
    });

    popup.appendChild(option);
  }

  // Close button event
  document.getElementById('closePopupBtn').addEventListener('click', () => {
    popup.style.display = 'none';
  });

  popup.style.display = 'block';
}



function updateEDLText() {
  let lines = edlText.split('\n');
  entries.forEach(entry => {
    // Update Marker-Zeile (Farbe und Kommentar)
    let markerLine = lines[entry.markerIndex];
    markerLine = markerLine.replace(/ResolveColor\w+/, entry.color);
    if (markerLine.includes('|M:')) {
      markerLine = markerLine.replace(/\|M:[^|]*/, '|M:' + entry.comment);
    } else {
      markerLine += ' |M:' + entry.comment;
    }
    lines[entry.markerIndex] = markerLine;

    // Update Timecode-Zeile
    const timeMatch = lines[entry.timeIndex].match(/(\d{2}:\d{2}:\d{2}:\d{2})/);
    if (timeMatch) {
      lines[entry.timeIndex] = lines[entry.timeIndex].replace(timeMatch[1], entry.timecode);
    }
  });
  modifiedEDL = lines.join('\n');
}


document.getElementById('downloadBtn').addEventListener('click', () => {
      const blob = new Blob([modifiedEDL], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = originalFilename + '_modified.edl';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  

document.getElementById('infoBtn').addEventListener('click', function() {
  document.getElementById('infoPopup').style.display = 'block';
});

/* Close popup when clicking outside it */
document.addEventListener('mousedown', function(event) {
  const popup = document.getElementById('popupContainer');
  if (!popup) return;
  const isInsidePopup = popup.contains(event.target);

  function isWithin(target, selector) {
    return target && target.closest && target.closest(selector);
  }

  const isColorBox = isWithin(event.target, '.color-box');
  const isColorCircle = isWithin(event.target, '.colorCircle');

  if (popup.style.display === 'block' && !isInsidePopup && !isColorBox && !isColorCircle) {
    popup.style.display = 'none';
  }
});


// Make popup draggable
(function makePopupDraggable() {
  const popup = document.getElementById('popupContainer');
  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;

  document.addEventListener('mousedown', function(e) {
    const header = document.getElementById('popupHeader');
    if (header && header.contains(e.target)) {
      isDragging = true;
      const rect = popup.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      popup.style.transition = 'none';
    }
  });

  document.addEventListener('mousemove', function(e) {
    if (isDragging) {
      popup.style.left = e.clientX - offsetX + 'px';
      popup.style.top = e.clientY - offsetY + 'px';
      popup.style.transform = 'none';
    }
  });

  document.addEventListener('mouseup', function() {
    isDragging = false;
  });
})();

</script>
</body>
</html>
